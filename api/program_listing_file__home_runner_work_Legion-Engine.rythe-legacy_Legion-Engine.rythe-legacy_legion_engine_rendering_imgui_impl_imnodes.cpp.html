
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Program Listing for File imnodes.cpp &#8212; LegionEngine v 0.2 alpha documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/nameko.css" />
    <link rel="stylesheet" type="text/css" href="../_static/collapsible-lists/css/tree_view.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
    <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Lora:400' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">LegionEngine v 0.2 alpha documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Program Listing for File imnodes.cpp</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="program-listing-for-file-imnodes-cpp">
<span id="program-listing-file-home-runner-work-legion-engine-rythe-legacy-legion-engine-rythe-legacy-legion-engine-rendering-imgui-impl-imnodes-cpp"></span><h1>Program Listing for File imnodes.cpp<a class="headerlink" href="#program-listing-for-file-imnodes-cpp" title="Permalink to this headline">¶</a></h1>
<p>↰ <a class="reference internal" href="file__home_runner_work_Legion-Engine.rythe-legacy_Legion-Engine.rythe-legacy_legion_engine_rendering_imgui_impl_imnodes.cpp.html#file-home-runner-work-legion-engine-rythe-legacy-legion-engine-rythe-legacy-legion-engine-rendering-imgui-impl-imnodes-cpp"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">/home/runner/work/Legion-Engine.rythe-legacy/Legion-Engine.rythe-legacy/legion/engine/rendering/imgui_impl/imnodes.cpp</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// the structure of this file:</span>
<span class="c1">//</span>
<span class="c1">// [SECTION] internal data structures</span>
<span class="c1">// [SECTION] global struct</span>
<span class="c1">// [SECTION] editor context definition</span>
<span class="c1">// [SECTION] draw list helper</span>
<span class="c1">// [SECTION] ObjectPool implementation</span>
<span class="c1">// [SECTION] ui state logic</span>
<span class="c1">// [SECTION] render helpers</span>
<span class="c1">// [SECTION] API implementation</span>

<span class="cp">#include</span> <span class="cpf">&lt;imgui/imnodes.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;imgui/imgui.h&gt;</span><span class="cp"></span>
<span class="cp">#define IMGUI_DEFINE_MATH_OPERATORS</span>
<span class="cp">#include</span> <span class="cpf">&lt;imgui/imgui_internal.h&gt;</span><span class="cp"></span>

<span class="c1">// Check minimum ImGui version</span>
<span class="cp">#define MINIMUM_COMPATIBLE_IMGUI_VERSION 16401</span>
<span class="cp">#if IMGUI_VERSION_NUM &lt; MINIMUM_COMPATIBLE_IMGUI_VERSION</span>
<span class="cp">#error &quot;Minimum ImGui version requirement not met -- please use a newer version!&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;limits.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;new&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="c1"> // strlen, strncmp</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="c1">  // for fwrite, ssprintf, sscanf</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="nn">imgui</span><span class="p">{</span>
<span class="k">namespace</span> <span class="nn">nodes</span>
<span class="p">{</span>
<span class="k">namespace</span>
<span class="p">{</span>
<span class="k">enum</span> <span class="nc">ScopeFlags</span>
<span class="p">{</span>
    <span class="n">Scope_None</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">Scope_Editor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">Scope_Node</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">Scope_Attribute</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="nc">AttributeType</span>
<span class="p">{</span>
    <span class="n">AttributeType_None</span><span class="p">,</span>
    <span class="n">AttributeType_Input</span><span class="p">,</span>
    <span class="n">AttributeType_Output</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="nc">ElementStateChange</span>
<span class="p">{</span>
    <span class="n">ElementStateChange_None</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">ElementStateChange_LinkStarted</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">ElementStateChange_LinkDropped</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">ElementStateChange_LinkCreated</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
<span class="p">};</span>

<span class="c1">// [SECTION] internal data structures</span>

<span class="c1">// The object T must have the following interface:</span>
<span class="c1">//</span>
<span class="c1">// struct T</span>
<span class="c1">// {</span>
<span class="c1">//     T();</span>
<span class="c1">//</span>
<span class="c1">//     int id;</span>
<span class="c1">// };</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="nc">ObjectPool</span>
<span class="p">{</span>
    <span class="n">ImVector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">pool</span><span class="p">;</span>
    <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">in_use</span><span class="p">;</span>
    <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">free_list</span><span class="p">;</span>
    <span class="n">ImGuiStorage</span> <span class="n">id_map</span><span class="p">;</span>

    <span class="n">ObjectPool</span><span class="p">()</span> <span class="o">:</span> <span class="n">pool</span><span class="p">(),</span> <span class="n">in_use</span><span class="p">(),</span> <span class="n">free_list</span><span class="p">(),</span> <span class="n">id_map</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="c1">// Emulates std::optional&lt;int&gt; using the sentinel value `invalid_index`.</span>
<span class="k">struct</span> <span class="nc">OptionalIndex</span>
<span class="p">{</span>
    <span class="n">OptionalIndex</span><span class="p">()</span> <span class="o">:</span> <span class="n">m_index</span><span class="p">(</span><span class="n">invalid_index</span><span class="p">)</span> <span class="p">{}</span>
    <span class="n">OptionalIndex</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="o">:</span> <span class="n">m_index</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{}</span>

    <span class="c1">// Observers</span>

    <span class="kr">inline</span> <span class="kt">bool</span> <span class="n">has_value</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_index</span> <span class="o">!=</span> <span class="n">invalid_index</span><span class="p">;</span> <span class="p">}</span>

    <span class="kr">inline</span> <span class="kt">int</span> <span class="n">value</span><span class="p">()</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">has_value</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">m_index</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Modifiers</span>

    <span class="kr">inline</span> <span class="n">OptionalIndex</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_index</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kr">inline</span> <span class="kt">void</span> <span class="n">reset</span><span class="p">()</span> <span class="p">{</span> <span class="n">m_index</span> <span class="o">=</span> <span class="n">invalid_index</span><span class="p">;</span> <span class="p">}</span>

    <span class="kr">inline</span> <span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">OptionalIndex</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_index</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">.</span><span class="n">m_index</span><span class="p">;</span> <span class="p">}</span>

    <span class="kr">inline</span> <span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">rhs</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_index</span> <span class="o">==</span> <span class="n">rhs</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">invalid_index</span> <span class="o">=</span> <span class="mi">-1</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
    <span class="kt">int</span> <span class="n">m_index</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">NodeData</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">ImVec2</span> <span class="n">origin</span><span class="p">;</span> <span class="c1">// The node origin is in editor space</span>
    <span class="n">ImRect</span> <span class="n">title_bar_content_rect</span><span class="p">;</span>
    <span class="n">ImRect</span> <span class="n">rect</span><span class="p">;</span>

    <span class="k">struct</span>
    <span class="p">{</span>
        <span class="n">ImU32</span> <span class="n">background</span><span class="p">,</span> <span class="n">background_hovered</span><span class="p">,</span> <span class="n">background_selected</span><span class="p">,</span> <span class="n">outline</span><span class="p">,</span> <span class="n">titlebar</span><span class="p">,</span>
            <span class="n">titlebar_hovered</span><span class="p">,</span> <span class="n">titlebar_selected</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">color_style</span><span class="p">;</span>

    <span class="k">struct</span>
    <span class="p">{</span>
        <span class="kt">float</span> <span class="n">corner_rounding</span><span class="p">;</span>
        <span class="n">ImVec2</span> <span class="n">padding</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">border_thickness</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">layout_style</span><span class="p">;</span>

    <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">pin_indices</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">draggable</span><span class="p">;</span>

    <span class="n">NodeData</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">node_id</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">id</span><span class="p">(</span><span class="n">node_id</span><span class="p">),</span> <span class="n">origin</span><span class="p">(</span><span class="mf">100.0f</span><span class="p">,</span> <span class="mf">100.0f</span><span class="p">),</span> <span class="n">title_bar_content_rect</span><span class="p">(),</span>
          <span class="n">rect</span><span class="p">(</span><span class="n">ImVec2</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">),</span> <span class="n">ImVec2</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">)),</span> <span class="n">color_style</span><span class="p">(),</span> <span class="n">layout_style</span><span class="p">(),</span>
          <span class="n">pin_indices</span><span class="p">(),</span> <span class="n">draggable</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">PinData</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">parent_node_idx</span><span class="p">;</span>
    <span class="n">ImRect</span> <span class="n">attribute_rect</span><span class="p">;</span>
    <span class="n">AttributeType</span> <span class="n">type</span><span class="p">;</span>
    <span class="n">PinShape</span> <span class="n">shape</span><span class="p">;</span>
    <span class="n">ImVec2</span> <span class="n">pos</span><span class="p">;</span> <span class="c1">// screen-space coordinates</span>
    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

    <span class="k">struct</span>
    <span class="p">{</span>
        <span class="n">ImU32</span> <span class="n">background</span><span class="p">,</span> <span class="n">hovered</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">color_style</span><span class="p">;</span>

    <span class="n">PinData</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">pin_id</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">id</span><span class="p">(</span><span class="n">pin_id</span><span class="p">),</span> <span class="n">parent_node_idx</span><span class="p">(),</span> <span class="n">attribute_rect</span><span class="p">(),</span> <span class="n">type</span><span class="p">(</span><span class="n">AttributeType_None</span><span class="p">),</span>
          <span class="n">shape</span><span class="p">(</span><span class="n">PinShape_CircleFilled</span><span class="p">),</span> <span class="n">pos</span><span class="p">(),</span> <span class="n">flags</span><span class="p">(</span><span class="n">AttributeFlags_None</span><span class="p">),</span> <span class="n">color_style</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">LinkData</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">start_pin_idx</span><span class="p">,</span> <span class="n">end_pin_idx</span><span class="p">;</span>

    <span class="k">struct</span>
    <span class="p">{</span>
        <span class="n">ImU32</span> <span class="n">base</span><span class="p">,</span> <span class="n">hovered</span><span class="p">,</span> <span class="n">selected</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">color_style</span><span class="p">;</span>

    <span class="n">LinkData</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">link_id</span><span class="p">)</span> <span class="o">:</span> <span class="n">id</span><span class="p">(</span><span class="n">link_id</span><span class="p">),</span> <span class="n">start_pin_idx</span><span class="p">(),</span> <span class="n">end_pin_idx</span><span class="p">(),</span> <span class="n">color_style</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">LinkPredicate</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">LinkData</span><span class="o">&amp;</span> <span class="n">lhs</span><span class="p">,</span> <span class="k">const</span> <span class="n">LinkData</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="c1">// Do a unique compare by sorting the pins&#39; addresses.</span>
        <span class="c1">// This catches duplicate links, whether they are in the</span>
        <span class="c1">// same direction or not.</span>
        <span class="c1">// Sorting by pin index should have the uniqueness guarantees as sorting</span>
        <span class="c1">// by id -- each unique id will get one slot in the link pool array.</span>

        <span class="kt">int</span> <span class="n">lhs_start</span> <span class="o">=</span> <span class="n">lhs</span><span class="p">.</span><span class="n">start_pin_idx</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">lhs_end</span> <span class="o">=</span> <span class="n">lhs</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">rhs_start</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">.</span><span class="n">start_pin_idx</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">rhs_end</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">lhs_start</span> <span class="o">&gt;</span> <span class="n">lhs_end</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ImSwap</span><span class="p">(</span><span class="n">lhs_start</span><span class="p">,</span> <span class="n">lhs_end</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rhs_start</span> <span class="o">&gt;</span> <span class="n">rhs_end</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ImSwap</span><span class="p">(</span><span class="n">rhs_start</span><span class="p">,</span> <span class="n">rhs_end</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">lhs_start</span> <span class="o">==</span> <span class="n">rhs_start</span> <span class="o">&amp;&amp;</span> <span class="n">lhs_end</span> <span class="o">==</span> <span class="n">rhs_end</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">BezierCurve</span>
<span class="p">{</span>
    <span class="c1">// the curve control points</span>
    <span class="n">ImVec2</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">LinkBezierData</span>
<span class="p">{</span>
    <span class="n">BezierCurve</span> <span class="n">bezier</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num_segments</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="nc">ClickInteractionType</span>
<span class="p">{</span>
    <span class="n">ClickInteractionType_Node</span><span class="p">,</span>
    <span class="n">ClickInteractionType_Link</span><span class="p">,</span>
    <span class="n">ClickInteractionType_LinkCreation</span><span class="p">,</span>
    <span class="n">ClickInteractionType_Panning</span><span class="p">,</span>
    <span class="n">ClickInteractionType_BoxSelection</span><span class="p">,</span>
    <span class="n">ClickInteractionType_None</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="nc">LinkCreationType</span>
<span class="p">{</span>
    <span class="n">LinkCreationType_Standard</span><span class="p">,</span>
    <span class="n">LinkCreationType_FromDetach</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">ClickInteractionState</span>
<span class="p">{</span>
    <span class="k">struct</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">start_pin_idx</span><span class="p">;</span>
        <span class="n">OptionalIndex</span> <span class="n">end_pin_idx</span><span class="p">;</span>
        <span class="n">LinkCreationType</span> <span class="n">link_creation_type</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">link_creation</span><span class="p">;</span>

    <span class="k">struct</span>
    <span class="p">{</span>
        <span class="n">ImRect</span> <span class="n">rect</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">box_selector</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">ColorStyleElement</span>
<span class="p">{</span>
    <span class="n">ImU32</span> <span class="n">color</span><span class="p">;</span>
    <span class="n">ColorStyle</span> <span class="n">item</span><span class="p">;</span>

    <span class="n">ColorStyleElement</span><span class="p">(</span><span class="k">const</span> <span class="n">ImU32</span> <span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="n">ColorStyle</span> <span class="n">s</span><span class="p">)</span> <span class="o">:</span> <span class="n">color</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">item</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">StyleElement</span>
<span class="p">{</span>
    <span class="n">StyleVar</span> <span class="n">item</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">value</span><span class="p">;</span>

    <span class="n">StyleElement</span><span class="p">(</span><span class="k">const</span> <span class="kt">float</span> <span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="n">StyleVar</span> <span class="n">variable</span><span class="p">)</span> <span class="o">:</span> <span class="n">item</span><span class="p">(</span><span class="n">variable</span><span class="p">),</span> <span class="n">value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="c1">// [SECTION] global struct</span>
<span class="c1">// this stores data which only lives for one frame</span>
<span class="k">struct</span>
<span class="p">{</span>
    <span class="n">EditorContext</span><span class="o">*</span> <span class="n">default_editor_ctx</span><span class="p">;</span>
    <span class="n">EditorContext</span><span class="o">*</span> <span class="n">editor_ctx</span><span class="p">;</span>

    <span class="c1">// Canvas draw list and helper state</span>
    <span class="n">ImDrawList</span><span class="o">*</span> <span class="n">canvas_draw_list</span><span class="p">;</span>
    <span class="n">ImGuiStorage</span> <span class="n">node_idx_to_submission_idx</span><span class="p">;</span>
    <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">node_idx_submission_order</span><span class="p">;</span>
    <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">node_indices_overlapping_with_mouse</span><span class="p">;</span>

    <span class="c1">// Canvas extents</span>
    <span class="n">ImVec2</span> <span class="n">canvas_origin_screen_space</span><span class="p">;</span>
    <span class="n">ImRect</span> <span class="n">canvas_rect_screen_space</span><span class="p">;</span>

    <span class="c1">// Debug helpers</span>
    <span class="n">ScopeFlags</span> <span class="n">current_scope</span><span class="p">;</span>

    <span class="c1">// Configuration state</span>
    <span class="n">IO</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">Style</span> <span class="n">style</span><span class="p">;</span>
    <span class="n">ImVector</span><span class="o">&lt;</span><span class="n">ColorStyleElement</span><span class="o">&gt;</span> <span class="n">color_modifier_stack</span><span class="p">;</span>
    <span class="n">ImVector</span><span class="o">&lt;</span><span class="n">StyleElement</span><span class="o">&gt;</span> <span class="n">style_modifier_stack</span><span class="p">;</span>
    <span class="n">ImGuiTextBuffer</span> <span class="n">text_buffer</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">current_attribute_flags</span><span class="p">;</span>
    <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">attribute_flag_stack</span><span class="p">;</span>

    <span class="c1">// UI element state</span>
    <span class="kt">int</span> <span class="n">current_node_idx</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">current_pin_idx</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">current_attribute_id</span><span class="p">;</span>

    <span class="n">OptionalIndex</span> <span class="n">hovered_node_idx</span><span class="p">;</span>
    <span class="n">OptionalIndex</span> <span class="n">interactive_node_idx</span><span class="p">;</span>
    <span class="n">OptionalIndex</span> <span class="n">hovered_link_idx</span><span class="p">;</span>
    <span class="n">OptionalIndex</span> <span class="n">hovered_pin_idx</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">hovered_pin_flags</span><span class="p">;</span>

    <span class="n">OptionalIndex</span> <span class="n">deleted_link_idx</span><span class="p">;</span>
    <span class="n">OptionalIndex</span> <span class="n">snap_link_idx</span><span class="p">;</span>

    <span class="c1">// Event helper state</span>
    <span class="kt">int</span> <span class="n">element_state_change</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">active_attribute_id</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">active_attribute</span><span class="p">;</span>

    <span class="c1">// ImGui::IO cache</span>

    <span class="n">ImVec2</span> <span class="n">mouse_pos</span><span class="p">;</span>

    <span class="kt">bool</span> <span class="n">left_mouse_clicked</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">left_mouse_released</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">middle_mouse_clicked</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">left_mouse_dragging</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">middle_mouse_dragging</span><span class="p">;</span>
<span class="p">}</span> <span class="n">g</span><span class="p">;</span>

<span class="n">EditorContext</span><span class="o">&amp;</span> <span class="nf">editor_context_get</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// No editor context was set! Did you forget to call imnodes::Initialize?</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">editor_ctx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">g</span><span class="p">.</span><span class="n">editor_ctx</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">bool</span> <span class="nf">is_mouse_hovering_near_point</span><span class="p">(</span><span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">point</span><span class="p">,</span> <span class="kt">float</span> <span class="n">radius</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ImVec2</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">mouse_pos</span> <span class="o">-</span> <span class="n">point</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">delta</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">delta</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">delta</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">delta</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">radius</span> <span class="o">*</span> <span class="n">radius</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">ImVec2</span> <span class="nf">eval_bezier</span><span class="p">(</span><span class="kt">float</span> <span class="n">t</span><span class="p">,</span> <span class="k">const</span> <span class="n">BezierCurve</span><span class="o">&amp;</span> <span class="n">bezier</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// B(t) = (1-t)**3 p0 + 3(1 - t)**2 t P1 + 3(1-t)t**2 P2 + t**3 P3</span>
    <span class="k">return</span> <span class="n">ImVec2</span><span class="p">(</span>
        <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">bezier</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">bezier</span><span class="p">.</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span>
            <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">bezier</span><span class="p">.</span><span class="n">p2</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">bezier</span><span class="p">.</span><span class="n">p3</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">bezier</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">bezier</span><span class="p">.</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span>
            <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">bezier</span><span class="p">.</span><span class="n">p2</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">bezier</span><span class="p">.</span><span class="n">p3</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Calculates the closest point along each bezier curve segment.</span>
<span class="n">ImVec2</span> <span class="nf">get_closest_point_on_cubic_bezier</span><span class="p">(</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">num_segments</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">BezierCurve</span><span class="o">&amp;</span> <span class="n">bezier</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">IM_ASSERT</span><span class="p">(</span><span class="n">num_segments</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">ImVec2</span> <span class="n">p_last</span> <span class="o">=</span> <span class="n">bezier</span><span class="p">.</span><span class="n">p0</span><span class="p">;</span>
    <span class="n">ImVec2</span> <span class="n">p_closest</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">p_closest_dist</span> <span class="o">=</span> <span class="n">FLT_MAX</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">t_step</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">/</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">num_segments</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">num_segments</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ImVec2</span> <span class="n">p_current</span> <span class="o">=</span> <span class="n">eval_bezier</span><span class="p">(</span><span class="n">t_step</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">bezier</span><span class="p">);</span>
        <span class="n">ImVec2</span> <span class="n">p_line</span> <span class="o">=</span> <span class="n">ImLineClosestPoint</span><span class="p">(</span><span class="n">p_last</span><span class="p">,</span> <span class="n">p_current</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">ImLengthSqr</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">p_line</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">p_closest_dist</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">p_closest</span> <span class="o">=</span> <span class="n">p_line</span><span class="p">;</span>
            <span class="n">p_closest_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">p_last</span> <span class="o">=</span> <span class="n">p_current</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">p_closest</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">float</span> <span class="nf">get_distance_to_cubic_bezier</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">pos</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">BezierCurve</span><span class="o">&amp;</span> <span class="n">bezier</span><span class="p">,</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">num_segments</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">ImVec2</span> <span class="n">point_on_curve</span> <span class="o">=</span> <span class="n">get_closest_point_on_cubic_bezier</span><span class="p">(</span><span class="n">num_segments</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">bezier</span><span class="p">);</span>

    <span class="k">const</span> <span class="n">ImVec2</span> <span class="n">to_curve</span> <span class="o">=</span> <span class="n">point_on_curve</span> <span class="o">-</span> <span class="n">pos</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">ImSqrt</span><span class="p">(</span><span class="n">ImLengthSqr</span><span class="p">(</span><span class="n">to_curve</span><span class="p">));</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">ImRect</span> <span class="nf">get_containing_rect_for_bezier_curve</span><span class="p">(</span><span class="k">const</span> <span class="n">BezierCurve</span><span class="o">&amp;</span> <span class="n">bezier</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">ImVec2</span> <span class="n">min</span> <span class="o">=</span> <span class="n">ImVec2</span><span class="p">(</span><span class="n">ImMin</span><span class="p">(</span><span class="n">bezier</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">bezier</span><span class="p">.</span><span class="n">p3</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="n">ImMin</span><span class="p">(</span><span class="n">bezier</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">bezier</span><span class="p">.</span><span class="n">p3</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>
    <span class="k">const</span> <span class="n">ImVec2</span> <span class="n">max</span> <span class="o">=</span> <span class="n">ImVec2</span><span class="p">(</span><span class="n">ImMax</span><span class="p">(</span><span class="n">bezier</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">bezier</span><span class="p">.</span><span class="n">p3</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="n">ImMax</span><span class="p">(</span><span class="n">bezier</span><span class="p">.</span><span class="n">p0</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">bezier</span><span class="p">.</span><span class="n">p3</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>

    <span class="k">const</span> <span class="kt">float</span> <span class="n">hover_distance</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">link_hover_distance</span><span class="p">;</span>

    <span class="n">ImRect</span> <span class="n">rect</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
    <span class="n">rect</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">bezier</span><span class="p">.</span><span class="n">p1</span><span class="p">);</span>
    <span class="n">rect</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">bezier</span><span class="p">.</span><span class="n">p2</span><span class="p">);</span>
    <span class="n">rect</span><span class="p">.</span><span class="n">Expand</span><span class="p">(</span><span class="n">ImVec2</span><span class="p">(</span><span class="n">hover_distance</span><span class="p">,</span> <span class="n">hover_distance</span><span class="p">));</span>

    <span class="k">return</span> <span class="n">rect</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">LinkBezierData</span> <span class="nf">get_link_renderable</span><span class="p">(</span>
    <span class="n">ImVec2</span> <span class="n">start</span><span class="p">,</span>
    <span class="n">ImVec2</span> <span class="n">end</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">AttributeType</span> <span class="n">start_type</span><span class="p">,</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">line_segments_per_length</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">((</span><span class="n">start_type</span> <span class="o">==</span> <span class="n">AttributeType_Input</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">start_type</span> <span class="o">==</span> <span class="n">AttributeType_Output</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">start_type</span> <span class="o">==</span> <span class="n">AttributeType_Input</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ImSwap</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">const</span> <span class="kt">float</span> <span class="n">link_length</span> <span class="o">=</span> <span class="n">ImSqrt</span><span class="p">(</span><span class="n">ImLengthSqr</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">));</span>
    <span class="k">const</span> <span class="n">ImVec2</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ImVec2</span><span class="p">(</span><span class="mf">0.25f</span> <span class="o">*</span> <span class="n">link_length</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">);</span>
    <span class="n">LinkBezierData</span> <span class="n">link_data</span><span class="p">;</span>
    <span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">.</span><span class="n">p0</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
    <span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
    <span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
    <span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">.</span><span class="n">p3</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
    <span class="n">link_data</span><span class="p">.</span><span class="n">num_segments</span> <span class="o">=</span> <span class="n">ImMax</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">link_length</span> <span class="o">*</span> <span class="n">line_segments_per_length</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">link_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">bool</span> <span class="nf">is_mouse_hovering_near_link</span><span class="p">(</span><span class="k">const</span> <span class="n">BezierCurve</span><span class="o">&amp;</span> <span class="n">bezier</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">num_segments</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">ImVec2</span> <span class="n">mouse_pos</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">mouse_pos</span><span class="p">;</span>

    <span class="c1">// First, do a simple bounding box test against the box containing the link</span>
    <span class="c1">// to see whether calculating the distance to the link is worth doing.</span>
    <span class="k">const</span> <span class="n">ImRect</span> <span class="n">link_rect</span> <span class="o">=</span> <span class="n">get_containing_rect_for_bezier_curve</span><span class="p">(</span><span class="n">bezier</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">link_rect</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">mouse_pos</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">float</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">get_distance_to_cubic_bezier</span><span class="p">(</span><span class="n">mouse_pos</span><span class="p">,</span> <span class="n">bezier</span><span class="p">,</span> <span class="n">num_segments</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">link_hover_distance</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">float</span> <span class="nf">eval_implicit_line_eq</span><span class="p">(</span><span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">p1</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">p2</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">p2</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">p2</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="n">p2</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">p1</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">p1</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">p2</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sign</span><span class="p">(</span><span class="kt">float</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kt">int</span><span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mf">0.0f</span><span class="p">)</span> <span class="o">-</span> <span class="kt">int</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mf">0.0f</span><span class="p">);</span> <span class="p">}</span>

<span class="kr">inline</span> <span class="kt">bool</span> <span class="nf">rectangle_overlaps_line_segment</span><span class="p">(</span><span class="k">const</span> <span class="n">ImRect</span><span class="o">&amp;</span> <span class="n">rect</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">p1</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">p2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Trivial case: rectangle contains an endpoint</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">||</span> <span class="n">rect</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">p2</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Flip rectangle if necessary</span>
    <span class="n">ImRect</span> <span class="n">flip_rect</span> <span class="o">=</span> <span class="n">rect</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">flip_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ImSwap</span><span class="p">(</span><span class="n">flip_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">flip_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ImSwap</span><span class="p">(</span><span class="n">flip_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Trivial case: line segment lies to one particular side of rectangle</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">p2</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">p2</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="n">p2</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="n">p2</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">y</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">const</span> <span class="kt">int</span> <span class="n">corner_signs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">sign</span><span class="p">(</span><span class="n">eval_implicit_line_eq</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">)),</span>
        <span class="n">sign</span><span class="p">(</span><span class="n">eval_implicit_line_eq</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">ImVec2</span><span class="p">(</span><span class="n">flip_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">y</span><span class="p">))),</span>
        <span class="n">sign</span><span class="p">(</span><span class="n">eval_implicit_line_eq</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">ImVec2</span><span class="p">(</span><span class="n">flip_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">y</span><span class="p">))),</span>
        <span class="n">sign</span><span class="p">(</span><span class="n">eval_implicit_line_eq</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">flip_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">))};</span>

    <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sum_abs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">corner_signs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">sum_abs</span> <span class="o">+=</span> <span class="n">abs</span><span class="p">(</span><span class="n">corner_signs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="c1">// At least one corner of rectangle lies on a different side of line segment</span>
    <span class="k">return</span> <span class="n">abs</span><span class="p">(</span><span class="n">sum</span><span class="p">)</span> <span class="o">!=</span> <span class="n">sum_abs</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">bool</span> <span class="nf">rectangle_overlaps_bezier</span><span class="p">(</span><span class="k">const</span> <span class="n">ImRect</span><span class="o">&amp;</span> <span class="n">rectangle</span><span class="p">,</span> <span class="k">const</span> <span class="n">LinkBezierData</span><span class="o">&amp;</span> <span class="n">link_data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ImVec2</span> <span class="n">current</span> <span class="o">=</span> <span class="n">eval_bezier</span><span class="p">(</span><span class="mf">0.f</span><span class="p">,</span> <span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">/</span> <span class="n">link_data</span><span class="p">.</span><span class="n">num_segments</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">link_data</span><span class="p">.</span><span class="n">num_segments</span><span class="p">;</span> <span class="o">++</span><span class="n">s</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ImVec2</span> <span class="n">next</span> <span class="o">=</span> <span class="n">eval_bezier</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">((</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span><span class="p">),</span> <span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rectangle_overlaps_line_segment</span><span class="p">(</span><span class="n">rectangle</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">next</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">bool</span> <span class="nf">rectangle_overlaps_link</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">ImRect</span><span class="o">&amp;</span> <span class="n">rectangle</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">start</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">end</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">AttributeType</span> <span class="n">start_type</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// First level: simple rejection test via rectangle overlap:</span>

    <span class="n">ImRect</span> <span class="n">lrect</span> <span class="o">=</span> <span class="n">ImRect</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lrect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">lrect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ImSwap</span><span class="p">(</span><span class="n">lrect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">lrect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lrect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">lrect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ImSwap</span><span class="p">(</span><span class="n">lrect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">lrect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rectangle</span><span class="p">.</span><span class="n">Overlaps</span><span class="p">(</span><span class="n">lrect</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// First, check if either one or both endpoinds are trivially contained</span>
        <span class="c1">// in the rectangle</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rectangle</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">||</span> <span class="n">rectangle</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Second level of refinement: do a more expensive test against the</span>
        <span class="c1">// link</span>

        <span class="k">const</span> <span class="n">LinkBezierData</span> <span class="n">link_data</span> <span class="o">=</span>
            <span class="n">get_link_renderable</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">start_type</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">link_line_segments_per_length</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rectangle_overlaps_bezier</span><span class="p">(</span><span class="n">rectangle</span><span class="p">,</span> <span class="n">link_data</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span> <span class="c1">// namespace</span>

<span class="c1">// [SECTION] editor context definition</span>

<span class="k">struct</span> <span class="nc">EditorContext</span>
<span class="p">{</span>
    <span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">NodeData</span><span class="o">&gt;</span> <span class="n">nodes</span><span class="p">;</span>
    <span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">PinData</span><span class="o">&gt;</span> <span class="n">pins</span><span class="p">;</span>
    <span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">LinkData</span><span class="o">&gt;</span> <span class="n">links</span><span class="p">;</span>

    <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">node_depth_order</span><span class="p">;</span>

    <span class="c1">// ui related fields</span>
    <span class="n">ImVec2</span> <span class="n">panning</span><span class="p">;</span>

    <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">selected_node_indices</span><span class="p">;</span>
    <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">selected_link_indices</span><span class="p">;</span>

    <span class="n">ClickInteractionType</span> <span class="n">click_interaction_type</span><span class="p">;</span>
    <span class="n">ClickInteractionState</span> <span class="n">click_interaction_state</span><span class="p">;</span>

    <span class="n">EditorContext</span><span class="p">()</span>
        <span class="o">:</span> <span class="n">nodes</span><span class="p">(),</span> <span class="n">pins</span><span class="p">(),</span> <span class="n">links</span><span class="p">(),</span> <span class="n">panning</span><span class="p">(</span><span class="mf">0.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">),</span> <span class="n">selected_node_indices</span><span class="p">(),</span>
          <span class="n">selected_link_indices</span><span class="p">(),</span> <span class="n">click_interaction_type</span><span class="p">(</span><span class="n">ClickInteractionType_None</span><span class="p">),</span>
          <span class="n">click_interaction_state</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">namespace</span>
<span class="p">{</span>
<span class="c1">// [SECTION] draw list helper</span>

<span class="kt">void</span> <span class="nf">ImDrawList_grow_channels</span><span class="p">(</span><span class="n">ImDrawList</span><span class="o">*</span> <span class="n">draw_list</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">num_channels</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ImDrawListSplitter</span><span class="o">&amp;</span> <span class="n">splitter</span> <span class="o">=</span> <span class="n">draw_list</span><span class="o">-&gt;</span><span class="n">_Splitter</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">splitter</span><span class="p">.</span><span class="n">_Count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">splitter</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="n">draw_list</span><span class="p">,</span> <span class="n">num_channels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// NOTE: this logic has been lifted from ImDrawListSplitter::Split with slight modifications</span>
    <span class="c1">// to allow nested splits. The main modification is that we only create new ImDrawChannel</span>
    <span class="c1">// instances after splitter._Count, instead of over the whole splitter._Channels array like</span>
    <span class="c1">// the regular ImDrawListSplitter::Split method does.</span>

    <span class="k">const</span> <span class="kt">int</span> <span class="n">old_channel_capacity</span> <span class="o">=</span> <span class="n">splitter</span><span class="p">.</span><span class="n">_Channels</span><span class="p">.</span><span class="n">Size</span><span class="p">;</span>
    <span class="c1">// NOTE: _Channels is not resized down, and therefore _Count &lt;= _Channels.size()!</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">old_channel_count</span> <span class="o">=</span> <span class="n">splitter</span><span class="p">.</span><span class="n">_Count</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">requested_channel_count</span> <span class="o">=</span> <span class="n">old_channel_count</span> <span class="o">+</span> <span class="n">num_channels</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">old_channel_capacity</span> <span class="o">&lt;</span> <span class="n">old_channel_count</span> <span class="o">+</span> <span class="n">num_channels</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">splitter</span><span class="p">.</span><span class="n">_Channels</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">requested_channel_count</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">splitter</span><span class="p">.</span><span class="n">_Count</span> <span class="o">=</span> <span class="n">requested_channel_count</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">old_channel_count</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">requested_channel_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ImDrawChannel</span><span class="o">&amp;</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">splitter</span><span class="p">.</span><span class="n">_Channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

        <span class="c1">// If we&#39;re inside the old capacity region of the array, we need to reuse the existing</span>
        <span class="c1">// memory of the command and index buffers.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">old_channel_capacity</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">channel</span><span class="p">.</span><span class="n">_CmdBuffer</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">channel</span><span class="p">.</span><span class="n">_IdxBuffer</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// Else, we need to construct new draw channels.</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">IM_PLACEMENT_NEW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="p">)</span> <span class="n">ImDrawChannel</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="p">{</span>
            <span class="n">ImDrawCmd</span> <span class="n">draw_cmd</span><span class="p">;</span>
            <span class="n">draw_cmd</span><span class="p">.</span><span class="n">ClipRect</span> <span class="o">=</span> <span class="n">draw_list</span><span class="o">-&gt;</span><span class="n">_ClipRectStack</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
            <span class="n">draw_cmd</span><span class="p">.</span><span class="n">TextureId</span> <span class="o">=</span> <span class="n">draw_list</span><span class="o">-&gt;</span><span class="n">_TextureIdStack</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
            <span class="n">channel</span><span class="p">.</span><span class="n">_CmdBuffer</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">draw_cmd</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ImDrawListSplitter_swap_channels</span><span class="p">(</span>
    <span class="n">ImDrawListSplitter</span><span class="o">&amp;</span> <span class="n">splitter</span><span class="p">,</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">lhs_idx</span><span class="p">,</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">rhs_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lhs_idx</span> <span class="o">==</span> <span class="n">rhs_idx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">lhs_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">lhs_idx</span> <span class="o">&lt;</span> <span class="n">splitter</span><span class="p">.</span><span class="n">_Count</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">rhs_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rhs_idx</span> <span class="o">&lt;</span> <span class="n">splitter</span><span class="p">.</span><span class="n">_Count</span><span class="p">);</span>

    <span class="n">ImDrawChannel</span><span class="o">&amp;</span> <span class="n">lhs_channel</span> <span class="o">=</span> <span class="n">splitter</span><span class="p">.</span><span class="n">_Channels</span><span class="p">[</span><span class="n">lhs_idx</span><span class="p">];</span>
    <span class="n">ImDrawChannel</span><span class="o">&amp;</span> <span class="n">rhs_channel</span> <span class="o">=</span> <span class="n">splitter</span><span class="p">.</span><span class="n">_Channels</span><span class="p">[</span><span class="n">rhs_idx</span><span class="p">];</span>
    <span class="n">lhs_channel</span><span class="p">.</span><span class="n">_CmdBuffer</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">rhs_channel</span><span class="p">.</span><span class="n">_CmdBuffer</span><span class="p">);</span>
    <span class="n">lhs_channel</span><span class="p">.</span><span class="n">_IdxBuffer</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">rhs_channel</span><span class="p">.</span><span class="n">_IdxBuffer</span><span class="p">);</span>

    <span class="k">const</span> <span class="kt">int</span> <span class="n">current_channel</span> <span class="o">=</span> <span class="n">splitter</span><span class="p">.</span><span class="n">_Current</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">current_channel</span> <span class="o">==</span> <span class="n">lhs_idx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">splitter</span><span class="p">.</span><span class="n">_Current</span> <span class="o">=</span> <span class="n">rhs_idx</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">current_channel</span> <span class="o">==</span> <span class="n">rhs_idx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">splitter</span><span class="p">.</span><span class="n">_Current</span> <span class="o">=</span> <span class="n">lhs_idx</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">draw_list_set</span><span class="p">(</span><span class="n">ImDrawList</span><span class="o">*</span> <span class="n">window_draw_list</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span> <span class="o">=</span> <span class="n">window_draw_list</span><span class="p">;</span>
    <span class="n">g</span><span class="p">.</span><span class="n">node_idx_to_submission_idx</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
    <span class="n">g</span><span class="p">.</span><span class="n">node_idx_submission_order</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// The draw list channels are structured as follows. First we have our base channel, the canvas grid</span>
<span class="c1">// on which we render the grid lines in BeginNodeEditor(). The base channel is the reason</span>
<span class="c1">// draw_list_submission_idx_to_background_channel_idx offsets the index by one. Each BeginNode()</span>
<span class="c1">// call appends two new draw channels, for the node background and foreground. The node foreground</span>
<span class="c1">// is the channel into which the node&#39;s ImGui content is rendered. Finally, in EndNodeEditor() we</span>
<span class="c1">// append one last draw channel for rendering the selection box and the incomplete link on top of</span>
<span class="c1">// everything else.</span>
<span class="c1">//</span>
<span class="c1">// +----------+----------+----------+----------+----------+----------+</span>
<span class="c1">// |          |          |          |          |          |          |</span>
<span class="c1">// |canvas    |node      |node      |...       |...       |click     |</span>
<span class="c1">// |grid      |background|foreground|          |          |interaction</span>
<span class="c1">// |          |          |          |          |          |          |</span>
<span class="c1">// +----------+----------+----------+----------+----------+----------+</span>
<span class="c1">//            |                     |</span>
<span class="c1">//            |   submission idx    |</span>
<span class="c1">//            |                     |</span>
<span class="c1">//            -----------------------</span>

<span class="kt">void</span> <span class="nf">draw_list_add_node</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">g</span><span class="p">.</span><span class="n">node_idx_to_submission_idx</span><span class="p">.</span><span class="n">SetInt</span><span class="p">(</span>
        <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ImGuiID</span><span class="o">&gt;</span><span class="p">(</span><span class="n">node_idx</span><span class="p">),</span> <span class="n">g</span><span class="p">.</span><span class="n">node_idx_submission_order</span><span class="p">.</span><span class="n">Size</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">node_idx_submission_order</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">node_idx</span><span class="p">);</span>
    <span class="n">ImDrawList_grow_channels</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">draw_list_append_click_interaction_channel</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// NOTE: don&#39;t use this function outside of EndNodeEditor. Using this before all nodes have been</span>
    <span class="c1">// added will screw up the node draw order.</span>
    <span class="n">ImDrawList_grow_channels</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">draw_list_submission_idx_to_background_channel_idx</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">submission_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// NOTE: the first channel is the canvas background, i.e. the grid</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">submission_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">draw_list_submission_idx_to_foreground_channel_idx</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">submission_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">draw_list_submission_idx_to_background_channel_idx</span><span class="p">(</span><span class="n">submission_idx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">draw_list_activate_click_interaction_channel</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">_Splitter</span><span class="p">.</span><span class="n">SetCurrentChannel</span><span class="p">(</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">_Splitter</span><span class="p">.</span><span class="n">_Count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">draw_list_activate_current_node_foreground</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">foreground_channel_idx</span> <span class="o">=</span>
        <span class="n">draw_list_submission_idx_to_foreground_channel_idx</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">node_idx_submission_order</span><span class="p">.</span><span class="n">Size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">_Splitter</span><span class="p">.</span><span class="n">SetCurrentChannel</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="p">,</span> <span class="n">foreground_channel_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">draw_list_activate_node_background</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">submission_idx</span> <span class="o">=</span>
        <span class="n">g</span><span class="p">.</span><span class="n">node_idx_to_submission_idx</span><span class="p">.</span><span class="n">GetInt</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ImGuiID</span><span class="o">&gt;</span><span class="p">(</span><span class="n">node_idx</span><span class="p">),</span> <span class="mi">-1</span><span class="p">);</span>
    <span class="c1">// There is a discrepancy in the submitted node count and the rendered node count! Did you call</span>
    <span class="c1">// one of the following functions</span>
    <span class="c1">// * EditorContextMoveToNode</span>
    <span class="c1">// * SetNodeScreenSpacePos</span>
    <span class="c1">// * SetNodeGridSpacePos</span>
    <span class="c1">// * SetNodeDraggable</span>
    <span class="c1">// after the BeginNode/EndNode function calls?</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">submission_idx</span> <span class="o">!=</span> <span class="mi">-1</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">background_channel_idx</span> <span class="o">=</span>
        <span class="n">draw_list_submission_idx_to_background_channel_idx</span><span class="p">(</span><span class="n">submission_idx</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">_Splitter</span><span class="p">.</span><span class="n">SetCurrentChannel</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="p">,</span> <span class="n">background_channel_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">draw_list_swap_submission_indices</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">lhs_idx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">rhs_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">lhs_idx</span> <span class="o">!=</span> <span class="n">rhs_idx</span><span class="p">);</span>

    <span class="k">const</span> <span class="kt">int</span> <span class="n">lhs_foreground_channel_idx</span> <span class="o">=</span>
        <span class="n">draw_list_submission_idx_to_foreground_channel_idx</span><span class="p">(</span><span class="n">lhs_idx</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">lhs_background_channel_idx</span> <span class="o">=</span>
        <span class="n">draw_list_submission_idx_to_background_channel_idx</span><span class="p">(</span><span class="n">lhs_idx</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">rhs_foreground_channel_idx</span> <span class="o">=</span>
        <span class="n">draw_list_submission_idx_to_foreground_channel_idx</span><span class="p">(</span><span class="n">rhs_idx</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">rhs_background_channel_idx</span> <span class="o">=</span>
        <span class="n">draw_list_submission_idx_to_background_channel_idx</span><span class="p">(</span><span class="n">rhs_idx</span><span class="p">);</span>

    <span class="n">ImDrawListSplitter_swap_channels</span><span class="p">(</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">_Splitter</span><span class="p">,</span> <span class="n">lhs_background_channel_idx</span><span class="p">,</span> <span class="n">rhs_background_channel_idx</span><span class="p">);</span>
    <span class="n">ImDrawListSplitter_swap_channels</span><span class="p">(</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">_Splitter</span><span class="p">,</span> <span class="n">lhs_foreground_channel_idx</span><span class="p">,</span> <span class="n">rhs_foreground_channel_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">draw_list_sort_channels_by_depth</span><span class="p">(</span><span class="k">const</span> <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">node_idx_depth_order</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">node_idx_to_submission_idx</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">Size</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">node_idx_depth_order</span><span class="p">.</span><span class="n">Size</span> <span class="o">==</span> <span class="n">g</span><span class="p">.</span><span class="n">node_idx_submission_order</span><span class="p">.</span><span class="n">Size</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">start_idx</span> <span class="o">=</span> <span class="n">node_idx_depth_order</span><span class="p">.</span><span class="n">Size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">node_idx_depth_order</span><span class="p">[</span><span class="n">start_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="p">.</span><span class="n">node_idx_submission_order</span><span class="p">[</span><span class="n">start_idx</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">start_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// early out if submission order and depth order are the same</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// TODO: this is an O(N^2) algorithm. It might be worthwhile revisiting this to see if the time</span>
    <span class="c1">// complexity can be reduced.</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">depth_idx</span> <span class="o">=</span> <span class="n">start_idx</span><span class="p">;</span> <span class="n">depth_idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">depth_idx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span> <span class="o">=</span> <span class="n">node_idx_depth_order</span><span class="p">[</span><span class="n">depth_idx</span><span class="p">];</span>

        <span class="c1">// Find the current index of the node_idx in the submission order array</span>
        <span class="kt">int</span> <span class="n">submission_idx</span> <span class="o">=</span> <span class="mi">-1</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">g</span><span class="p">.</span><span class="n">node_idx_submission_order</span><span class="p">.</span><span class="n">Size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">node_idx_submission_order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">node_idx</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">submission_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">submission_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">submission_idx</span> <span class="o">==</span> <span class="n">depth_idx</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">submission_idx</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">depth_idx</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">draw_list_swap_submission_indices</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">ImSwap</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">node_idx_submission_order</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">g</span><span class="p">.</span><span class="n">node_idx_submission_order</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// [SECTION] ObjectPool implementation</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">int</span> <span class="n">object_pool_find</span><span class="p">(</span><span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">objects</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">objects</span><span class="p">.</span><span class="n">id_map</span><span class="p">.</span><span class="n">GetInt</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ImGuiID</span><span class="o">&gt;</span><span class="p">(</span><span class="n">id</span><span class="p">),</span> <span class="mi">-1</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">object_pool_update</span><span class="p">(</span><span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">objects</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">objects</span><span class="p">.</span><span class="n">free_list</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">objects</span><span class="p">.</span><span class="n">in_use</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">objects</span><span class="p">.</span><span class="n">in_use</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="p">{</span>
            <span class="n">objects</span><span class="p">.</span><span class="n">id_map</span><span class="p">.</span><span class="n">SetInt</span><span class="p">(</span><span class="n">objects</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">,</span> <span class="mi">-1</span><span class="p">);</span>
            <span class="n">objects</span><span class="p">.</span><span class="n">free_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="p">(</span><span class="n">objects</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">Data</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;~</span><span class="n">T</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;&gt;</span>
<span class="kt">void</span> <span class="n">object_pool_update</span><span class="p">(</span><span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">NodeData</span><span class="o">&gt;&amp;</span> <span class="n">nodes</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">nodes</span><span class="p">.</span><span class="n">free_list</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nodes</span><span class="p">.</span><span class="n">in_use</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">in_use</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="p">{</span>
            <span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pin_indices</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="kt">int</span> <span class="n">previous_id</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
            <span class="k">const</span> <span class="kt">int</span> <span class="n">previous_idx</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">.</span><span class="n">id_map</span><span class="p">.</span><span class="n">GetInt</span><span class="p">(</span><span class="n">previous_id</span><span class="p">,</span> <span class="mi">-1</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">previous_idx</span> <span class="o">!=</span> <span class="mi">-1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Remove node idx form depth stack the first time we detect that this idx slot is</span>
                <span class="c1">// unused</span>
                <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">depth_stack</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">().</span><span class="n">node_depth_order</span><span class="p">;</span>
                <span class="k">const</span> <span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">elem</span> <span class="o">=</span> <span class="n">depth_stack</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                <span class="n">assert</span><span class="p">(</span><span class="n">elem</span> <span class="o">!=</span> <span class="n">depth_stack</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
                <span class="n">depth_stack</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">nodes</span><span class="p">.</span><span class="n">id_map</span><span class="p">.</span><span class="n">SetInt</span><span class="p">(</span><span class="n">previous_id</span><span class="p">,</span> <span class="mi">-1</span><span class="p">);</span>
            <span class="n">nodes</span><span class="p">.</span><span class="n">free_list</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">Data</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;~</span><span class="n">NodeData</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">object_pool_reset</span><span class="p">(</span><span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">objects</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">objects</span><span class="p">.</span><span class="n">in_use</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">objects</span><span class="p">.</span><span class="n">in_use</span><span class="p">.</span><span class="n">Data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">objects</span><span class="p">.</span><span class="n">in_use</span><span class="p">.</span><span class="n">size_in_bytes</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">int</span> <span class="n">object_pool_find_or_create_index</span><span class="p">(</span><span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">objects</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">objects</span><span class="p">.</span><span class="n">id_map</span><span class="p">.</span><span class="n">GetInt</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ImGuiID</span><span class="o">&gt;</span><span class="p">(</span><span class="n">id</span><span class="p">),</span> <span class="mi">-1</span><span class="p">);</span>

    <span class="c1">// Construct new object</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">-1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">objects</span><span class="p">.</span><span class="n">free_list</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">objects</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
            <span class="n">IM_ASSERT</span><span class="p">(</span><span class="n">objects</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">objects</span><span class="p">.</span><span class="n">in_use</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
            <span class="k">const</span> <span class="kt">int</span> <span class="n">new_size</span> <span class="o">=</span> <span class="n">objects</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">objects</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">new_size</span><span class="p">);</span>
            <span class="n">objects</span><span class="p">.</span><span class="n">in_use</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">new_size</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">objects</span><span class="p">.</span><span class="n">free_list</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
            <span class="n">objects</span><span class="p">.</span><span class="n">free_list</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">IM_PLACEMENT_NEW</span><span class="p">(</span><span class="n">objects</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">Data</span> <span class="o">+</span> <span class="n">index</span><span class="p">)</span> <span class="n">T</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
        <span class="n">objects</span><span class="p">.</span><span class="n">id_map</span><span class="p">.</span><span class="n">SetInt</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ImGuiID</span><span class="o">&gt;</span><span class="p">(</span><span class="n">id</span><span class="p">),</span> <span class="n">index</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Flag it as used</span>
    <span class="n">objects</span><span class="p">.</span><span class="n">in_use</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;&gt;</span>
<span class="kt">int</span> <span class="n">object_pool_find_or_create_index</span><span class="p">(</span><span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">NodeData</span><span class="o">&gt;&amp;</span> <span class="n">nodes</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">node_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">node_idx</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">.</span><span class="n">id_map</span><span class="p">.</span><span class="n">GetInt</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ImGuiID</span><span class="o">&gt;</span><span class="p">(</span><span class="n">node_id</span><span class="p">),</span> <span class="mi">-1</span><span class="p">);</span>

    <span class="c1">// Construct new node</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">node_idx</span> <span class="o">==</span> <span class="mi">-1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">free_list</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">node_idx</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
            <span class="n">IM_ASSERT</span><span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">nodes</span><span class="p">.</span><span class="n">in_use</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
            <span class="k">const</span> <span class="kt">int</span> <span class="n">new_size</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">new_size</span><span class="p">);</span>
            <span class="n">nodes</span><span class="p">.</span><span class="n">in_use</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">new_size</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">node_idx</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">.</span><span class="n">free_list</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
            <span class="n">nodes</span><span class="p">.</span><span class="n">free_list</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">IM_PLACEMENT_NEW</span><span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">Data</span> <span class="o">+</span> <span class="n">node_idx</span><span class="p">)</span> <span class="n">NodeData</span><span class="p">(</span><span class="n">node_id</span><span class="p">);</span>
        <span class="n">nodes</span><span class="p">.</span><span class="n">id_map</span><span class="p">.</span><span class="n">SetInt</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">ImGuiID</span><span class="o">&gt;</span><span class="p">(</span><span class="n">node_id</span><span class="p">),</span> <span class="n">node_idx</span><span class="p">);</span>

        <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
        <span class="n">editor</span><span class="p">.</span><span class="n">node_depth_order</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">node_idx</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Flag node as used</span>
    <span class="n">nodes</span><span class="p">.</span><span class="n">in_use</span><span class="p">[</span><span class="n">node_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">node_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span>
<span class="n">T</span><span class="o">&amp;</span> <span class="n">object_pool_find_or_create_object</span><span class="p">(</span><span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">objects</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">object_pool_find_or_create_index</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">objects</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">// [SECTION] ui state logic</span>

<span class="n">ImVec2</span> <span class="n">get_screen_space_pin_coordinates</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">ImRect</span><span class="o">&amp;</span> <span class="n">node_rect</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">ImRect</span><span class="o">&amp;</span> <span class="n">attribute_rect</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">AttributeType</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AttributeType_Input</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">AttributeType_Output</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">x</span> <span class="o">=</span> <span class="n">type</span> <span class="o">==</span> <span class="n">AttributeType_Input</span> <span class="o">?</span> <span class="p">(</span><span class="n">node_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_offset</span><span class="p">)</span>
                                                <span class="o">:</span> <span class="p">(</span><span class="n">node_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_offset</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ImVec2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.5f</span> <span class="o">*</span> <span class="p">(</span><span class="n">attribute_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">attribute_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">ImVec2</span> <span class="n">get_screen_space_pin_coordinates</span><span class="p">(</span><span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">ImRect</span><span class="o">&amp;</span> <span class="n">parent_node_rect</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">pin</span><span class="p">.</span><span class="n">parent_node_idx</span><span class="p">].</span><span class="n">rect</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">get_screen_space_pin_coordinates</span><span class="p">(</span><span class="n">parent_node_rect</span><span class="p">,</span> <span class="n">pin</span><span class="p">.</span><span class="n">attribute_rect</span><span class="p">,</span> <span class="n">pin</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// These functions are here, and not members of the BoxSelector struct, because</span>
<span class="c1">// implementing a C API in C++ is frustrating. EditorContext has a BoxSelector</span>
<span class="c1">// field, but the state changes depend on the editor. So, these are implemented</span>
<span class="c1">// as C-style free functions so that the code is not too much of a mish-mash of</span>
<span class="c1">// C functions and C++ method definitions.</span>

<span class="kt">bool</span> <span class="n">mouse_in_canvas</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">g</span><span class="p">.</span><span class="n">canvas_rect_screen_space</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">ImGui</span><span class="o">::</span><span class="n">GetMousePos</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">IsWindowHovered</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">begin_node_selection</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Don&#39;t start selecting a node if we are e.g. already creating and dragging</span>
    <span class="c1">// a new link! New link creation can happen when the mouse is clicked over</span>
    <span class="c1">// a node, but within the hover radius of a pin.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">!=</span> <span class="n">ClickInteractionType_None</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">=</span> <span class="n">ClickInteractionType_Node</span><span class="p">;</span>
    <span class="c1">// If the node is not already contained in the selection, then we want only</span>
    <span class="c1">// the interaction node to be selected, effective immediately.</span>
    <span class="c1">//</span>
    <span class="c1">// Otherwise, we want to allow for the possibility of multiple nodes to be</span>
    <span class="c1">// moved at once.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">editor</span><span class="p">.</span><span class="n">selected_node_indices</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">node_idx</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">editor</span><span class="p">.</span><span class="n">selected_node_indices</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
        <span class="n">editor</span><span class="p">.</span><span class="n">selected_link_indices</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
        <span class="n">editor</span><span class="p">.</span><span class="n">selected_node_indices</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">node_idx</span><span class="p">);</span>

        <span class="c1">// Ensure that individually selected nodes get rendered on top</span>
        <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">depth_stack</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">node_depth_order</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">elem</span> <span class="o">=</span> <span class="n">depth_stack</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">node_idx</span><span class="p">);</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">elem</span> <span class="o">!=</span> <span class="n">depth_stack</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
        <span class="n">depth_stack</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">elem</span><span class="p">);</span>
        <span class="n">depth_stack</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">node_idx</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">begin_link_selection</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">link_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">=</span> <span class="n">ClickInteractionType_Link</span><span class="p">;</span>
    <span class="c1">// When a link is selected, clear all other selections, and insert the link</span>
    <span class="c1">// as the sole selection.</span>
    <span class="n">editor</span><span class="p">.</span><span class="n">selected_node_indices</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">editor</span><span class="p">.</span><span class="n">selected_link_indices</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">editor</span><span class="p">.</span><span class="n">selected_link_indices</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">link_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">begin_link_detach</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">link_idx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">detach_pin_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">LinkData</span><span class="o">&amp;</span> <span class="n">link</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">link_idx</span><span class="p">];</span>
    <span class="n">ClickInteractionState</span><span class="o">&amp;</span> <span class="n">state</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
    <span class="n">state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">start_pin_idx</span> <span class="o">=</span>
        <span class="n">detach_pin_idx</span> <span class="o">==</span> <span class="n">link</span><span class="p">.</span><span class="n">start_pin_idx</span> <span class="o">?</span> <span class="n">link</span><span class="p">.</span><span class="nl">end_pin_idx</span> <span class="p">:</span> <span class="n">link</span><span class="p">.</span><span class="n">start_pin_idx</span><span class="p">;</span>
    <span class="n">g</span><span class="p">.</span><span class="n">deleted_link_idx</span> <span class="o">=</span> <span class="n">link_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">begin_link_interaction</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">link_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// First check if we are clicking a link in the vicinity of a pin.</span>
    <span class="c1">// This may result in a link detach via click and drag.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">==</span> <span class="n">ClickInteractionType_LinkCreation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_flags</span> <span class="o">&amp;</span> <span class="n">AttributeFlags_EnableLinkDetachWithDragClick</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">begin_link_detach</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">link_idx</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">.</span><span class="n">value</span><span class="p">());</span>
            <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">link_creation_type</span> <span class="o">=</span>
                <span class="n">LinkCreationType_FromDetach</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// If we aren&#39;t near a pin, check if we are clicking the link with the</span>
    <span class="c1">// modifier pressed. This may also result in a link detach via clicking.</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">bool</span> <span class="n">modifier_pressed</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">link_detach_with_modifier_click</span><span class="p">.</span><span class="n">modifier</span> <span class="o">==</span> <span class="nb">NULL</span>
                                          <span class="o">?</span> <span class="nb">false</span>
                                          <span class="o">:</span> <span class="o">*</span><span class="n">g</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">link_detach_with_modifier_click</span><span class="p">.</span><span class="n">modifier</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">modifier_pressed</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="n">LinkData</span><span class="o">&amp;</span> <span class="n">link</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">link_idx</span><span class="p">];</span>
            <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">start_pin</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">link</span><span class="p">.</span><span class="n">start_pin_idx</span><span class="p">];</span>
            <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">end_pin</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">link</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">];</span>
            <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">mouse_pos</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">mouse_pos</span><span class="p">;</span>
            <span class="k">const</span> <span class="kt">float</span> <span class="n">dist_to_start</span> <span class="o">=</span> <span class="n">ImLengthSqr</span><span class="p">(</span><span class="n">start_pin</span><span class="p">.</span><span class="n">pos</span> <span class="o">-</span> <span class="n">mouse_pos</span><span class="p">);</span>
            <span class="k">const</span> <span class="kt">float</span> <span class="n">dist_to_end</span> <span class="o">=</span> <span class="n">ImLengthSqr</span><span class="p">(</span><span class="n">end_pin</span><span class="p">.</span><span class="n">pos</span> <span class="o">-</span> <span class="n">mouse_pos</span><span class="p">);</span>
            <span class="k">const</span> <span class="kt">int</span> <span class="n">closest_pin_idx</span> <span class="o">=</span>
                <span class="n">dist_to_start</span> <span class="o">&lt;</span> <span class="n">dist_to_end</span> <span class="o">?</span> <span class="n">link</span><span class="p">.</span><span class="nl">start_pin_idx</span> <span class="p">:</span> <span class="n">link</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">;</span>

            <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">=</span> <span class="n">ClickInteractionType_LinkCreation</span><span class="p">;</span>
            <span class="n">begin_link_detach</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">link_idx</span><span class="p">,</span> <span class="n">closest_pin_idx</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">begin_link_selection</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">link_idx</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">begin_link_creation</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">hovered_pin_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">=</span> <span class="n">ClickInteractionType_LinkCreation</span><span class="p">;</span>
    <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">start_pin_idx</span> <span class="o">=</span> <span class="n">hovered_pin_idx</span><span class="p">;</span>
    <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
    <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">link_creation_type</span> <span class="o">=</span> <span class="n">LinkCreationType_Standard</span><span class="p">;</span>
    <span class="n">g</span><span class="p">.</span><span class="n">element_state_change</span> <span class="o">|=</span> <span class="n">ElementStateChange_LinkStarted</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">begin_canvas_interaction</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">bool</span> <span class="n">any_ui_element_hovered</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">hovered_node_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">||</span>
                                        <span class="n">g</span><span class="p">.</span><span class="n">hovered_link_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">||</span>
                                        <span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">||</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">IsAnyItemHovered</span><span class="p">();</span>

    <span class="k">const</span> <span class="kt">bool</span> <span class="n">mouse_not_in_canvas</span> <span class="o">=</span> <span class="o">!</span><span class="n">mouse_in_canvas</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">!=</span> <span class="n">ClickInteractionType_None</span> <span class="o">||</span> <span class="n">any_ui_element_hovered</span> <span class="o">||</span>
        <span class="n">mouse_not_in_canvas</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">const</span> <span class="kt">bool</span> <span class="n">started_panning</span> <span class="o">=</span>
        <span class="n">g</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">emulate_three_button_mouse</span><span class="p">.</span><span class="n">enabled</span>
            <span class="o">?</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">left_mouse_clicked</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">g</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">emulate_three_button_mouse</span><span class="p">.</span><span class="n">modifier</span><span class="p">)</span>
            <span class="o">:</span> <span class="n">g</span><span class="p">.</span><span class="n">middle_mouse_clicked</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">started_panning</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">=</span> <span class="n">ClickInteractionType_Panning</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">left_mouse_clicked</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">=</span> <span class="n">ClickInteractionType_BoxSelection</span><span class="p">;</span>
        <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">box_selector</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">Min</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">mouse_pos</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">box_selector_update_selection</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="n">ImRect</span> <span class="n">box_rect</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Invert box selector coordinates as needed</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">box_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">box_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ImSwap</span><span class="p">(</span><span class="n">box_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">box_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">box_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">box_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ImSwap</span><span class="p">(</span><span class="n">box_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">box_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Update node selection</span>

    <span class="n">editor</span><span class="p">.</span><span class="n">selected_node_indices</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

    <span class="c1">// Test for overlap against node rectangles</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">node_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">node_idx</span> <span class="o">&lt;</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">node_idx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">in_use</span><span class="p">[</span><span class="n">node_idx</span><span class="p">])</span>
        <span class="p">{</span>
            <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">node_idx</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">box_rect</span><span class="p">.</span><span class="n">Overlaps</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">rect</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">editor</span><span class="p">.</span><span class="n">selected_node_indices</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">node_idx</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Update link selection</span>

    <span class="n">editor</span><span class="p">.</span><span class="n">selected_link_indices</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

    <span class="c1">// Test for overlap against links</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">link_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">link_idx</span> <span class="o">&lt;</span> <span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">link_idx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">in_use</span><span class="p">[</span><span class="n">link_idx</span><span class="p">])</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="n">LinkData</span><span class="o">&amp;</span> <span class="n">link</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">link_idx</span><span class="p">];</span>

            <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">pin_start</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">link</span><span class="p">.</span><span class="n">start_pin_idx</span><span class="p">];</span>
            <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">pin_end</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">link</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">];</span>
            <span class="k">const</span> <span class="n">ImRect</span><span class="o">&amp;</span> <span class="n">node_start_rect</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">pin_start</span><span class="p">.</span><span class="n">parent_node_idx</span><span class="p">].</span><span class="n">rect</span><span class="p">;</span>
            <span class="k">const</span> <span class="n">ImRect</span><span class="o">&amp;</span> <span class="n">node_end_rect</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">pin_end</span><span class="p">.</span><span class="n">parent_node_idx</span><span class="p">].</span><span class="n">rect</span><span class="p">;</span>

            <span class="k">const</span> <span class="n">ImVec2</span> <span class="n">start</span> <span class="o">=</span> <span class="n">get_screen_space_pin_coordinates</span><span class="p">(</span>
                <span class="n">node_start_rect</span><span class="p">,</span> <span class="n">pin_start</span><span class="p">.</span><span class="n">attribute_rect</span><span class="p">,</span> <span class="n">pin_start</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
            <span class="k">const</span> <span class="n">ImVec2</span> <span class="n">end</span> <span class="o">=</span> <span class="n">get_screen_space_pin_coordinates</span><span class="p">(</span>
                <span class="n">node_end_rect</span><span class="p">,</span> <span class="n">pin_end</span><span class="p">.</span><span class="n">attribute_rect</span><span class="p">,</span> <span class="n">pin_end</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>

            <span class="c1">// Test</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rectangle_overlaps_link</span><span class="p">(</span><span class="n">box_rect</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">pin_start</span><span class="p">.</span><span class="n">type</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">editor</span><span class="p">.</span><span class="n">selected_link_indices</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">link_idx</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">translate_selected_nodes</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">left_mouse_dragging</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">ImGuiIO</span><span class="o">&amp;</span> <span class="n">io</span> <span class="o">=</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">GetIO</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">editor</span><span class="p">.</span><span class="n">selected_node_indices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">selected_node_indices</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">node_idx</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">draggable</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">node</span><span class="p">.</span><span class="n">origin</span> <span class="o">+=</span> <span class="n">io</span><span class="p">.</span><span class="n">MouseDelta</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">OptionalIndex</span> <span class="n">find_duplicate_link</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">start_pin_idx</span><span class="p">,</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">end_pin_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">LinkData</span> <span class="nf">test_link</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">test_link</span><span class="p">.</span><span class="n">start_pin_idx</span> <span class="o">=</span> <span class="n">start_pin_idx</span><span class="p">;</span>
    <span class="n">test_link</span><span class="p">.</span><span class="n">end_pin_idx</span> <span class="o">=</span> <span class="n">end_pin_idx</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">link_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">link_idx</span> <span class="o">&lt;</span> <span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">link_idx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">LinkData</span><span class="o">&amp;</span> <span class="n">link</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">link_idx</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">LinkPredicate</span><span class="p">()(</span><span class="n">test_link</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">in_use</span><span class="p">[</span><span class="n">link_idx</span><span class="p">])</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">OptionalIndex</span><span class="p">(</span><span class="n">link_idx</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">OptionalIndex</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">should_link_snap_to_pin</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">start_pin</span><span class="p">,</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">hovered_pin_idx</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">OptionalIndex</span> <span class="n">duplicate_link</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">end_pin</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">hovered_pin_idx</span><span class="p">];</span>

    <span class="c1">// The end pin must be in a different node</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">start_pin</span><span class="p">.</span><span class="n">parent_node_idx</span> <span class="o">==</span> <span class="n">end_pin</span><span class="p">.</span><span class="n">parent_node_idx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// The end pin must be of a different type</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">start_pin</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">end_pin</span><span class="p">.</span><span class="n">type</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// The link to be created must not be a duplicate, unless it is the link which was created on</span>
    <span class="c1">// snap. In that case we want to snap, since we want it to appear visually as if the created</span>
    <span class="c1">// link remains snapped to the pin.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">duplicate_link</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">duplicate_link</span> <span class="o">==</span> <span class="n">g</span><span class="p">.</span><span class="n">snap_link_idx</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">click_interaction_update</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="nl">ClickInteractionType_BoxSelection</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="n">ImRect</span><span class="o">&amp;</span> <span class="n">box_rect</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">box_selector</span><span class="p">.</span><span class="n">rect</span><span class="p">;</span>
        <span class="n">box_rect</span><span class="p">.</span><span class="n">Max</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">mouse_pos</span><span class="p">;</span>

        <span class="n">box_selector_update_selection</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">box_rect</span><span class="p">);</span>

        <span class="k">const</span> <span class="n">ImU32</span> <span class="n">box_selector_color</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_BoxSelector</span><span class="p">];</span>
        <span class="k">const</span> <span class="n">ImU32</span> <span class="n">box_selector_outline</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_BoxSelectorOutline</span><span class="p">];</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddRectFilled</span><span class="p">(</span><span class="n">box_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">,</span> <span class="n">box_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">,</span> <span class="n">box_selector_color</span><span class="p">);</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddRect</span><span class="p">(</span><span class="n">box_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">,</span> <span class="n">box_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">,</span> <span class="n">box_selector_outline</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">left_mouse_released</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">depth_stack</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">node_depth_order</span><span class="p">;</span>
            <span class="k">const</span> <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">selected_idxs</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">selected_node_indices</span><span class="p">;</span>

            <span class="c1">// Bump the selected node indices, in order, to the top of the depth stack.</span>
            <span class="c1">// NOTE: this algorithm has worst case time complexity of O(N^2), if the node selection</span>
            <span class="c1">// is ~ N (due to selected_idxs.contains()).</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">selected_idxs</span><span class="p">.</span><span class="n">Size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">selected_idxs</span><span class="p">.</span><span class="n">Size</span> <span class="o">&lt;</span> <span class="n">depth_stack</span><span class="p">.</span><span class="n">Size</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">num_moved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// The number of indices moved. Stop after selected_idxs.Size</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">depth_stack</span><span class="p">.</span><span class="n">Size</span> <span class="o">-</span> <span class="n">selected_idxs</span><span class="p">.</span><span class="n">Size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">node_idx</span> <span class="o">=</span> <span class="n">depth_stack</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">selected_idxs</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">node_idx</span><span class="p">);</span>
                         <span class="n">node_idx</span> <span class="o">=</span> <span class="n">depth_stack</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="p">{</span>
                        <span class="n">depth_stack</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">depth_stack</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
                        <span class="n">depth_stack</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">node_idx</span><span class="p">);</span>
                        <span class="o">++</span><span class="n">num_moved</span><span class="p">;</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">num_moved</span> <span class="o">==</span> <span class="n">selected_idxs</span><span class="p">.</span><span class="n">Size</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">=</span> <span class="n">ClickInteractionType_None</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">ClickInteractionType_Node</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="n">translate_selected_nodes</span><span class="p">(</span><span class="n">editor</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">left_mouse_released</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">=</span> <span class="n">ClickInteractionType_None</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">ClickInteractionType_Link</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">left_mouse_released</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">=</span> <span class="n">ClickInteractionType_None</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">ClickInteractionType_LinkCreation</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">start_pin</span> <span class="o">=</span>
            <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">start_pin_idx</span><span class="p">];</span>

        <span class="k">const</span> <span class="n">OptionalIndex</span> <span class="n">maybe_duplicate_link_idx</span> <span class="o">=</span>
            <span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span>
                <span class="o">?</span> <span class="n">find_duplicate_link</span><span class="p">(</span>
                      <span class="n">editor</span><span class="p">,</span>
                      <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">start_pin_idx</span><span class="p">,</span>
                      <span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">.</span><span class="n">value</span><span class="p">())</span>
                <span class="o">:</span> <span class="n">OptionalIndex</span><span class="p">();</span>

        <span class="k">const</span> <span class="kt">bool</span> <span class="n">should_snap</span> <span class="o">=</span>
            <span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
            <span class="n">should_link_snap_to_pin</span><span class="p">(</span>
                <span class="n">editor</span><span class="p">,</span> <span class="n">start_pin</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">.</span><span class="n">value</span><span class="p">(),</span> <span class="n">maybe_duplicate_link_idx</span><span class="p">);</span>

        <span class="c1">// If we created on snap and the hovered pin is empty or changed, then we need signal that</span>
        <span class="c1">// the link&#39;s state has changed.</span>
        <span class="k">const</span> <span class="kt">bool</span> <span class="n">snapping_pin_changed</span> <span class="o">=</span>
            <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span> <span class="o">==</span> <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">);</span>

        <span class="c1">// Detach the link that was created by this link event if it&#39;s no longer in snap range</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">snapping_pin_changed</span> <span class="o">&amp;&amp;</span> <span class="n">g</span><span class="p">.</span><span class="n">snap_link_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">begin_link_detach</span><span class="p">(</span>
                <span class="n">editor</span><span class="p">,</span>
                <span class="n">g</span><span class="p">.</span><span class="n">snap_link_idx</span><span class="p">.</span><span class="n">value</span><span class="p">(),</span>
                <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">.</span><span class="n">value</span><span class="p">());</span>
        <span class="p">}</span>

        <span class="k">const</span> <span class="n">ImVec2</span> <span class="n">start_pos</span> <span class="o">=</span> <span class="n">get_screen_space_pin_coordinates</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">start_pin</span><span class="p">);</span>
        <span class="c1">// If we are within the hover radius of a receiving pin, snap the link</span>
        <span class="c1">// endpoint to it</span>
        <span class="k">const</span> <span class="n">ImVec2</span> <span class="n">end_pos</span> <span class="o">=</span> <span class="n">should_snap</span>
                                   <span class="o">?</span> <span class="n">get_screen_space_pin_coordinates</span><span class="p">(</span>
                                         <span class="n">editor</span><span class="p">,</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">.</span><span class="n">value</span><span class="p">()])</span>
                                   <span class="o">:</span> <span class="n">g</span><span class="p">.</span><span class="n">mouse_pos</span><span class="p">;</span>

        <span class="k">const</span> <span class="n">LinkBezierData</span> <span class="n">link_data</span> <span class="o">=</span> <span class="n">get_link_renderable</span><span class="p">(</span>
            <span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">start_pin</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">link_line_segments_per_length</span><span class="p">);</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddBezierCurve</span><span class="p">(</span>
            <span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">.</span><span class="n">p0</span><span class="p">,</span>
            <span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">.</span><span class="n">p1</span><span class="p">,</span>
            <span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">.</span><span class="n">p2</span><span class="p">,</span>
            <span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">.</span><span class="n">p3</span><span class="p">,</span>
            <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_Link</span><span class="p">],</span>
            <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">link_thickness</span><span class="p">,</span>
            <span class="n">link_data</span><span class="p">.</span><span class="n">num_segments</span><span class="p">);</span>

        <span class="k">const</span> <span class="kt">bool</span> <span class="n">link_creation_on_snap</span> <span class="o">=</span>
            <span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">.</span><span class="n">value</span><span class="p">()].</span><span class="n">flags</span> <span class="o">&amp;</span>
                                              <span class="n">AttributeFlags_EnableLinkCreationOnSnap</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">should_snap</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">const</span> <span class="kt">bool</span> <span class="n">create_link</span> <span class="o">=</span> <span class="n">should_snap</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">left_mouse_released</span> <span class="o">||</span> <span class="n">link_creation_on_snap</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">create_link</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">maybe_duplicate_link_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="c1">// Avoid send OnLinkCreated() events every frame if the snap link is not saved</span>
            <span class="c1">// (only applies for EnableLinkCreationOnSnap)</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g</span><span class="p">.</span><span class="n">left_mouse_released</span> <span class="o">&amp;&amp;</span>
                <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">end_pin_idx</span> <span class="o">==</span> <span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">g</span><span class="p">.</span><span class="n">element_state_change</span> <span class="o">|=</span> <span class="n">ElementStateChange_LinkCreated</span><span class="p">;</span>
            <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">end_pin_idx</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">left_mouse_released</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">=</span> <span class="n">ClickInteractionType_None</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">create_link</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">g</span><span class="p">.</span><span class="n">element_state_change</span> <span class="o">|=</span> <span class="n">ElementStateChange_LinkDropped</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">ClickInteractionType_Panning</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">bool</span> <span class="n">dragging</span> <span class="o">=</span>
            <span class="n">g</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">emulate_three_button_mouse</span><span class="p">.</span><span class="n">enabled</span>
                <span class="o">?</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">left_mouse_dragging</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">g</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">emulate_three_button_mouse</span><span class="p">.</span><span class="n">modifier</span><span class="p">))</span>
                <span class="o">:</span> <span class="n">g</span><span class="p">.</span><span class="n">middle_mouse_dragging</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dragging</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">editor</span><span class="p">.</span><span class="n">panning</span> <span class="o">+=</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">GetIO</span><span class="p">().</span><span class="n">MouseDelta</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">=</span> <span class="n">ClickInteractionType_None</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">ClickInteractionType_None</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="s">&quot;Unreachable code!&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">OptionalIndex</span> <span class="n">resolve_hovered_node</span><span class="p">(</span><span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">node_indices_overlapping_with_mouse</span><span class="p">.</span><span class="n">Size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">OptionalIndex</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">largest_depth_idx</span> <span class="o">=</span> <span class="mi">-1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">node_idx_on_top</span> <span class="o">=</span> <span class="mi">-1</span><span class="p">;</span>

    <span class="k">const</span> <span class="n">ImVector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">depth_stack</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">node_depth_order</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">g</span><span class="p">.</span><span class="n">node_indices_overlapping_with_mouse</span><span class="p">.</span><span class="n">Size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">node_indices_overlapping_with_mouse</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">depth_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">depth_idx</span> <span class="o">&lt;</span> <span class="n">depth_stack</span><span class="p">.</span><span class="n">Size</span><span class="p">;</span> <span class="o">++</span><span class="n">depth_idx</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">depth_stack</span><span class="p">[</span><span class="n">depth_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">node_idx</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">depth_idx</span> <span class="o">&gt;</span> <span class="n">largest_depth_idx</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">largest_depth_idx</span> <span class="o">=</span> <span class="n">depth_idx</span><span class="p">;</span>
                <span class="n">node_idx_on_top</span> <span class="o">=</span> <span class="n">node_idx</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">node_idx_on_top</span> <span class="o">!=</span> <span class="mi">-1</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">OptionalIndex</span><span class="p">(</span><span class="n">node_idx_on_top</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// [SECTION] render helpers</span>

<span class="kr">inline</span> <span class="n">ImVec2</span> <span class="n">screen_space_to_grid_space</span><span class="p">(</span><span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">v</span> <span class="o">-</span> <span class="n">g</span><span class="p">.</span><span class="n">canvas_origin_screen_space</span> <span class="o">-</span> <span class="n">editor</span><span class="p">.</span><span class="n">panning</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">ImVec2</span> <span class="n">grid_space_to_screen_space</span><span class="p">(</span><span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">v</span> <span class="o">+</span> <span class="n">g</span><span class="p">.</span><span class="n">canvas_origin_screen_space</span> <span class="o">+</span> <span class="n">editor</span><span class="p">.</span><span class="n">panning</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">ImVec2</span> <span class="n">grid_space_to_editor_space</span><span class="p">(</span><span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">v</span> <span class="o">+</span> <span class="n">editor</span><span class="p">.</span><span class="n">panning</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">ImVec2</span> <span class="n">editor_space_to_grid_space</span><span class="p">(</span><span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">v</span> <span class="o">-</span> <span class="n">editor</span><span class="p">.</span><span class="n">panning</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">ImVec2</span> <span class="n">editor_space_to_screen_space</span><span class="p">(</span><span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">g</span><span class="p">.</span><span class="n">canvas_origin_screen_space</span> <span class="o">+</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">ImRect</span> <span class="n">get_item_rect</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ImRect</span><span class="p">(</span><span class="n">ImGui</span><span class="o">::</span><span class="n">GetItemRectMin</span><span class="p">(),</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">GetItemRectMax</span><span class="p">());</span> <span class="p">}</span>

<span class="kr">inline</span> <span class="n">ImVec2</span> <span class="n">get_node_title_bar_origin</span><span class="p">(</span><span class="k">const</span> <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">node</span><span class="p">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">node</span><span class="p">.</span><span class="n">layout_style</span><span class="p">.</span><span class="n">padding</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">ImVec2</span> <span class="n">get_node_content_origin</span><span class="p">(</span><span class="k">const</span> <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">ImVec2</span> <span class="n">title_bar_height</span> <span class="o">=</span>
        <span class="n">ImVec2</span><span class="p">(</span><span class="mf">0.f</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">title_bar_content_rect</span><span class="p">.</span><span class="n">GetHeight</span><span class="p">()</span> <span class="o">+</span> <span class="mf">2.0f</span> <span class="o">*</span> <span class="n">node</span><span class="p">.</span><span class="n">layout_style</span><span class="p">.</span><span class="n">padding</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">node</span><span class="p">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">title_bar_height</span> <span class="o">+</span> <span class="n">node</span><span class="p">.</span><span class="n">layout_style</span><span class="p">.</span><span class="n">padding</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">ImRect</span> <span class="n">get_node_title_rect</span><span class="p">(</span><span class="k">const</span> <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ImRect</span> <span class="n">expanded_title_rect</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">title_bar_content_rect</span><span class="p">;</span>
    <span class="n">expanded_title_rect</span><span class="p">.</span><span class="n">Expand</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">layout_style</span><span class="p">.</span><span class="n">padding</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">ImRect</span><span class="p">(</span>
        <span class="n">expanded_title_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">,</span>
        <span class="n">expanded_title_rect</span><span class="p">.</span><span class="n">Min</span> <span class="o">+</span> <span class="n">ImVec2</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">GetWidth</span><span class="p">(),</span> <span class="mf">0.f</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">ImVec2</span><span class="p">(</span><span class="mf">0.f</span><span class="p">,</span> <span class="n">expanded_title_rect</span><span class="p">.</span><span class="n">GetHeight</span><span class="p">()));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">draw_grid</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">canvas_size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">ImVec2</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">panning</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">float</span> <span class="n">x</span> <span class="o">=</span> <span class="n">fmodf</span><span class="p">(</span><span class="n">offset</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">grid_spacing</span><span class="p">);</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">canvas_size</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
         <span class="n">x</span> <span class="o">+=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">grid_spacing</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddLine</span><span class="p">(</span>
            <span class="n">editor_space_to_screen_space</span><span class="p">(</span><span class="n">ImVec2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">)),</span>
            <span class="n">editor_space_to_screen_space</span><span class="p">(</span><span class="n">ImVec2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">canvas_size</span><span class="p">.</span><span class="n">y</span><span class="p">)),</span>
            <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_GridLine</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">float</span> <span class="n">y</span> <span class="o">=</span> <span class="n">fmodf</span><span class="p">(</span><span class="n">offset</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">grid_spacing</span><span class="p">);</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">canvas_size</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
         <span class="n">y</span> <span class="o">+=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">grid_spacing</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddLine</span><span class="p">(</span>
            <span class="n">editor_space_to_screen_space</span><span class="p">(</span><span class="n">ImVec2</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span> <span class="n">y</span><span class="p">)),</span>
            <span class="n">editor_space_to_screen_space</span><span class="p">(</span><span class="n">ImVec2</span><span class="p">(</span><span class="n">canvas_size</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)),</span>
            <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_GridLine</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="nc">QuadOffsets</span>
<span class="p">{</span>
    <span class="n">ImVec2</span> <span class="n">top_left</span><span class="p">,</span> <span class="n">bottom_left</span><span class="p">,</span> <span class="n">bottom_right</span><span class="p">,</span> <span class="n">top_right</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">QuadOffsets</span> <span class="nf">calculate_quad_offsets</span><span class="p">(</span><span class="k">const</span> <span class="kt">float</span> <span class="n">side_length</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">half_side</span> <span class="o">=</span> <span class="mf">0.5f</span> <span class="o">*</span> <span class="n">side_length</span><span class="p">;</span>

    <span class="n">QuadOffsets</span> <span class="n">offset</span><span class="p">;</span>

    <span class="n">offset</span><span class="p">.</span><span class="n">top_left</span> <span class="o">=</span> <span class="n">ImVec2</span><span class="p">(</span><span class="o">-</span><span class="n">half_side</span><span class="p">,</span> <span class="n">half_side</span><span class="p">);</span>
    <span class="n">offset</span><span class="p">.</span><span class="n">bottom_left</span> <span class="o">=</span> <span class="n">ImVec2</span><span class="p">(</span><span class="o">-</span><span class="n">half_side</span><span class="p">,</span> <span class="o">-</span><span class="n">half_side</span><span class="p">);</span>
    <span class="n">offset</span><span class="p">.</span><span class="n">bottom_right</span> <span class="o">=</span> <span class="n">ImVec2</span><span class="p">(</span><span class="n">half_side</span><span class="p">,</span> <span class="o">-</span><span class="n">half_side</span><span class="p">);</span>
    <span class="n">offset</span><span class="p">.</span><span class="n">top_right</span> <span class="o">=</span> <span class="n">ImVec2</span><span class="p">(</span><span class="n">half_side</span><span class="p">,</span> <span class="n">half_side</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="nc">TriangleOffsets</span>
<span class="p">{</span>
    <span class="n">ImVec2</span> <span class="n">top_left</span><span class="p">,</span> <span class="n">bottom_left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">TriangleOffsets</span> <span class="nf">calculate_triangle_offsets</span><span class="p">(</span><span class="k">const</span> <span class="kt">float</span> <span class="n">side_length</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Calculates the Vec2 offsets from an equilateral triangle&#39;s midpoint to</span>
    <span class="c1">// its vertices. Here is how the left_offset and right_offset are</span>
    <span class="c1">// calculated.</span>
    <span class="c1">//</span>
    <span class="c1">// For an equilateral triangle of side length s, the</span>
    <span class="c1">// triangle&#39;s height, h, is h = s * sqrt(3) / 2.</span>
    <span class="c1">//</span>
    <span class="c1">// The length from the base to the midpoint is (1 / 3) * h. The length from</span>
    <span class="c1">// the midpoint to the triangle vertex is (2 / 3) * h.</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">sqrt_3</span> <span class="o">=</span> <span class="n">sqrtf</span><span class="p">(</span><span class="mf">3.0f</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">left_offset</span> <span class="o">=</span> <span class="mf">-0.1666666666667f</span> <span class="o">*</span> <span class="n">sqrt_3</span> <span class="o">*</span> <span class="n">side_length</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">right_offset</span> <span class="o">=</span> <span class="mf">0.333333333333f</span> <span class="o">*</span> <span class="n">sqrt_3</span> <span class="o">*</span> <span class="n">side_length</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="n">vertical_offset</span> <span class="o">=</span> <span class="mf">0.5f</span> <span class="o">*</span> <span class="n">side_length</span><span class="p">;</span>

    <span class="n">TriangleOffsets</span> <span class="n">offset</span><span class="p">;</span>
    <span class="n">offset</span><span class="p">.</span><span class="n">top_left</span> <span class="o">=</span> <span class="n">ImVec2</span><span class="p">(</span><span class="n">left_offset</span><span class="p">,</span> <span class="n">vertical_offset</span><span class="p">);</span>
    <span class="n">offset</span><span class="p">.</span><span class="n">bottom_left</span> <span class="o">=</span> <span class="n">ImVec2</span><span class="p">(</span><span class="n">left_offset</span><span class="p">,</span> <span class="o">-</span><span class="n">vertical_offset</span><span class="p">);</span>
    <span class="n">offset</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">ImVec2</span><span class="p">(</span><span class="n">right_offset</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">draw_pin_shape</span><span class="p">(</span><span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">pin_pos</span><span class="p">,</span> <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">pin</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImU32</span> <span class="n">pin_color</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">circle_num_segments</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">pin</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="nl">PinShape_Circle</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddCircle</span><span class="p">(</span>
            <span class="n">pin_pos</span><span class="p">,</span>
            <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_circle_radius</span><span class="p">,</span>
            <span class="n">pin_color</span><span class="p">,</span>
            <span class="n">circle_num_segments</span><span class="p">,</span>
            <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_line_thickness</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">PinShape_CircleFilled</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddCircleFilled</span><span class="p">(</span>
            <span class="n">pin_pos</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_circle_radius</span><span class="p">,</span> <span class="n">pin_color</span><span class="p">,</span> <span class="n">circle_num_segments</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">PinShape_Quad</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">QuadOffsets</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">calculate_quad_offsets</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_quad_side_length</span><span class="p">);</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddQuad</span><span class="p">(</span>
            <span class="n">pin_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">top_left</span><span class="p">,</span>
            <span class="n">pin_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">bottom_left</span><span class="p">,</span>
            <span class="n">pin_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">bottom_right</span><span class="p">,</span>
            <span class="n">pin_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">top_right</span><span class="p">,</span>
            <span class="n">pin_color</span><span class="p">,</span>
            <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_line_thickness</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">PinShape_QuadFilled</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">QuadOffsets</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">calculate_quad_offsets</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_quad_side_length</span><span class="p">);</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddQuadFilled</span><span class="p">(</span>
            <span class="n">pin_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">top_left</span><span class="p">,</span>
            <span class="n">pin_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">bottom_left</span><span class="p">,</span>
            <span class="n">pin_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">bottom_right</span><span class="p">,</span>
            <span class="n">pin_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">top_right</span><span class="p">,</span>
            <span class="n">pin_color</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">PinShape_Triangle</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">TriangleOffsets</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">calculate_triangle_offsets</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_triangle_side_length</span><span class="p">);</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddTriangle</span><span class="p">(</span>
            <span class="n">pin_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">top_left</span><span class="p">,</span>
            <span class="n">pin_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">bottom_left</span><span class="p">,</span>
            <span class="n">pin_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">right</span><span class="p">,</span>
            <span class="n">pin_color</span><span class="p">,</span>
            <span class="c1">// NOTE: for some weird reason, the line drawn by AddTriangle is</span>
            <span class="c1">// much thinner than the lines drawn by AddCircle or AddQuad.</span>
            <span class="c1">// Multiplying the line thickness by two seemed to solve the</span>
            <span class="c1">// problem at a few different thickness values.</span>
            <span class="mf">2.f</span> <span class="o">*</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_line_thickness</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">PinShape_TriangleFilled</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">TriangleOffsets</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">calculate_triangle_offsets</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_triangle_side_length</span><span class="p">);</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddTriangleFilled</span><span class="p">(</span>
            <span class="n">pin_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">top_left</span><span class="p">,</span>
            <span class="n">pin_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">bottom_left</span><span class="p">,</span>
            <span class="n">pin_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">right</span><span class="p">,</span>
            <span class="n">pin_color</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="s">&quot;Invalid PinShape value!&quot;</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="nf">is_pin_hovered</span><span class="p">(</span><span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">is_mouse_hovering_near_point</span><span class="p">(</span><span class="n">pin</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_hover_radius</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">draw_pin</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">pin_idx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">left_mouse_clicked</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">];</span>
    <span class="k">const</span> <span class="n">ImRect</span><span class="o">&amp;</span> <span class="n">parent_node_rect</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">pin</span><span class="p">.</span><span class="n">parent_node_idx</span><span class="p">].</span><span class="n">rect</span><span class="p">;</span>

    <span class="n">pin</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">get_screen_space_pin_coordinates</span><span class="p">(</span><span class="n">parent_node_rect</span><span class="p">,</span> <span class="n">pin</span><span class="p">.</span><span class="n">attribute_rect</span><span class="p">,</span> <span class="n">pin</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>

    <span class="n">ImU32</span> <span class="n">pin_color</span> <span class="o">=</span> <span class="n">pin</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">background</span><span class="p">;</span>

    <span class="k">const</span> <span class="kt">bool</span> <span class="n">pin_hovered</span> <span class="o">=</span> <span class="n">is_pin_hovered</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mouse_in_canvas</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                             <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">!=</span> <span class="n">ClickInteractionType_BoxSelection</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pin_hovered</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span> <span class="o">=</span> <span class="n">pin_idx</span><span class="p">;</span>
        <span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_flags</span> <span class="o">=</span> <span class="n">pin</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
        <span class="n">pin_color</span> <span class="o">=</span> <span class="n">pin</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">hovered</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">left_mouse_clicked</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">begin_link_creation</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">pin_idx</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">draw_pin_shape</span><span class="p">(</span><span class="n">pin</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">pin_color</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// TODO: Separate hover code from drawing code to avoid this unpleasant divergent function signature.</span>
<span class="kt">bool</span> <span class="nf">is_node_hovered</span><span class="p">(</span><span class="k">const</span> <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span><span class="p">,</span> <span class="k">const</span> <span class="n">ObjectPool</span><span class="o">&lt;</span><span class="n">PinData</span><span class="o">&gt;</span> <span class="n">pins</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// We render pins on top of nodes. In order to prevent node interaction when a pin is on top of</span>
    <span class="c1">// a node, we just early out here if a pin is hovered.</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">node</span><span class="p">.</span><span class="n">pin_indices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">node</span><span class="p">.</span><span class="n">pin_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_pin_hovered</span><span class="p">(</span><span class="n">pin</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">g</span><span class="p">.</span><span class="n">hovered_node_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">node_idx</span> <span class="o">==</span> <span class="n">g</span><span class="p">.</span><span class="n">hovered_node_idx</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// TODO: It may be useful to make this an EditorContext method, since this uses</span>
<span class="c1">// a lot of editor state. Currently that is just not clear, since we don&#39;t pass</span>
<span class="c1">// the editor as a part of the function signature.</span>
<span class="kt">void</span> <span class="nf">draw_node</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">node_idx</span><span class="p">];</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">SetCursorPos</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">origin</span> <span class="o">+</span> <span class="n">editor</span><span class="p">.</span><span class="n">panning</span><span class="p">);</span>

    <span class="k">const</span> <span class="kt">bool</span> <span class="n">node_hovered</span> <span class="o">=</span> <span class="n">is_node_hovered</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node_idx</span><span class="p">,</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mouse_in_canvas</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                              <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">!=</span> <span class="n">ClickInteractionType_BoxSelection</span><span class="p">;</span>

    <span class="n">ImU32</span> <span class="n">node_background</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">background</span><span class="p">;</span>
    <span class="n">ImU32</span> <span class="n">titlebar_background</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">titlebar</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">selected_node_indices</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">node_idx</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">node_background</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">background_selected</span><span class="p">;</span>
        <span class="n">titlebar_background</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">titlebar_selected</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">node_hovered</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">node_background</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">background_hovered</span><span class="p">;</span>
        <span class="n">titlebar_background</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">titlebar_hovered</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">{</span>
        <span class="c1">// node base</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddRectFilled</span><span class="p">(</span>
            <span class="n">node</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">Min</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">Max</span><span class="p">,</span> <span class="n">node_background</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">layout_style</span><span class="p">.</span><span class="n">corner_rounding</span><span class="p">);</span>

        <span class="c1">// title bar:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">title_bar_content_rect</span><span class="p">.</span><span class="n">GetHeight</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.f</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ImRect</span> <span class="n">title_bar_rect</span> <span class="o">=</span> <span class="n">get_node_title_rect</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

            <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddRectFilled</span><span class="p">(</span>
                <span class="n">title_bar_rect</span><span class="p">.</span><span class="n">Min</span><span class="p">,</span>
                <span class="n">title_bar_rect</span><span class="p">.</span><span class="n">Max</span><span class="p">,</span>
                <span class="n">titlebar_background</span><span class="p">,</span>
                <span class="n">node</span><span class="p">.</span><span class="n">layout_style</span><span class="p">.</span><span class="n">corner_rounding</span><span class="p">,</span>
                <span class="n">ImDrawCornerFlags_Top</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">StyleFlags_NodeOutline</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddRect</span><span class="p">(</span>
                <span class="n">node</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">Min</span><span class="p">,</span>
                <span class="n">node</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">Max</span><span class="p">,</span>
                <span class="n">node</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">outline</span><span class="p">,</span>
                <span class="n">node</span><span class="p">.</span><span class="n">layout_style</span><span class="p">.</span><span class="n">corner_rounding</span><span class="p">,</span>
                <span class="n">ImDrawCornerFlags_All</span><span class="p">,</span>
                <span class="n">node</span><span class="p">.</span><span class="n">layout_style</span><span class="p">.</span><span class="n">border_thickness</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">node</span><span class="p">.</span><span class="n">pin_indices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">draw_pin</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">pin_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">g</span><span class="p">.</span><span class="n">left_mouse_clicked</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">node_hovered</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">g</span><span class="p">.</span><span class="n">hovered_node_idx</span> <span class="o">=</span> <span class="n">node_idx</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">bool</span> <span class="n">node_ui_interaction</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">interactive_node_idx</span> <span class="o">==</span> <span class="n">node_idx</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">left_mouse_clicked</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">node_ui_interaction</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">begin_node_selection</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">node_idx</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="nf">is_link_hovered</span><span class="p">(</span><span class="k">const</span> <span class="n">LinkBezierData</span><span class="o">&amp;</span> <span class="n">link_data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// We render pins and nodes on top of links. In order to prevent link interaction when a pin or</span>
    <span class="c1">// node is on top of a link, we just early out here if a pin or node is hovered.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">()</span> <span class="o">||</span> <span class="n">g</span><span class="p">.</span><span class="n">hovered_node_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">is_mouse_hovering_near_link</span><span class="p">(</span><span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">,</span> <span class="n">link_data</span><span class="p">.</span><span class="n">num_segments</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">draw_link</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">link_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">LinkData</span><span class="o">&amp;</span> <span class="n">link</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">link_idx</span><span class="p">];</span>
    <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">start_pin</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">link</span><span class="p">.</span><span class="n">start_pin_idx</span><span class="p">];</span>
    <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">end_pin</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">link</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">];</span>

    <span class="k">const</span> <span class="n">LinkBezierData</span> <span class="n">link_data</span> <span class="o">=</span> <span class="n">get_link_renderable</span><span class="p">(</span>
        <span class="n">start_pin</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">end_pin</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">start_pin</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">link_line_segments_per_length</span><span class="p">);</span>

    <span class="k">const</span> <span class="kt">bool</span> <span class="n">link_hovered</span> <span class="o">=</span> <span class="n">is_link_hovered</span><span class="p">(</span><span class="n">link_data</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mouse_in_canvas</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                              <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">!=</span> <span class="n">ClickInteractionType_BoxSelection</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">link_hovered</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">g</span><span class="p">.</span><span class="n">hovered_link_idx</span> <span class="o">=</span> <span class="n">link_idx</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">left_mouse_clicked</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">begin_link_interaction</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">link_idx</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// It&#39;s possible for a link to be deleted in begin_link_interaction. A user</span>
    <span class="c1">// may detach a link, resulting in the link wire snapping to the mouse</span>
    <span class="c1">// position.</span>
    <span class="c1">//</span>
    <span class="c1">// In other words, skip rendering the link if it was deleted.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">deleted_link_idx</span> <span class="o">==</span> <span class="n">link_idx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ImU32</span> <span class="n">link_color</span> <span class="o">=</span> <span class="n">link</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">selected_link_indices</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">link_idx</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">link_color</span> <span class="o">=</span> <span class="n">link</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">selected</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">link_hovered</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">link_color</span> <span class="o">=</span> <span class="n">link</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">hovered</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">AddBezierCurve</span><span class="p">(</span>
        <span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">.</span><span class="n">p0</span><span class="p">,</span>
        <span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">.</span><span class="n">p1</span><span class="p">,</span>
        <span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">.</span><span class="n">p2</span><span class="p">,</span>
        <span class="n">link_data</span><span class="p">.</span><span class="n">bezier</span><span class="p">.</span><span class="n">p3</span><span class="p">,</span>
        <span class="n">link_color</span><span class="p">,</span>
        <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">link_thickness</span><span class="p">,</span>
        <span class="n">link_data</span><span class="p">.</span><span class="n">num_segments</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">begin_pin_attribute</span><span class="p">(</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">AttributeType</span> <span class="n">type</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">PinShape</span> <span class="n">shape</span><span class="p">,</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Make sure to call BeginNode() before calling</span>
    <span class="c1">// BeginAttribute()</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_Node</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">=</span> <span class="n">Scope_Attribute</span><span class="p">;</span>

    <span class="n">ImGui</span><span class="o">::</span><span class="n">BeginGroup</span><span class="p">();</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">PushID</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>

    <span class="n">g</span><span class="p">.</span><span class="n">current_attribute_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

    <span class="k">const</span> <span class="kt">int</span> <span class="n">pin_idx</span> <span class="o">=</span> <span class="n">object_pool_find_or_create_index</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">current_pin_idx</span> <span class="o">=</span> <span class="n">pin_idx</span><span class="p">;</span>
    <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">];</span>
    <span class="n">pin</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">pin</span><span class="p">.</span><span class="n">parent_node_idx</span> <span class="o">=</span> <span class="n">node_idx</span><span class="p">;</span>
    <span class="n">pin</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
    <span class="n">pin</span><span class="p">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">;</span>
    <span class="n">pin</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">current_attribute_flags</span><span class="p">;</span>
    <span class="n">pin</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_Pin</span><span class="p">];</span>
    <span class="n">pin</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">hovered</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_PinHovered</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">end_pin_attribute</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_Attribute</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">=</span> <span class="n">Scope_Node</span><span class="p">;</span>

    <span class="n">ImGui</span><span class="o">::</span><span class="n">PopID</span><span class="p">();</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">EndGroup</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ImGui</span><span class="o">::</span><span class="n">IsItemActive</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">g</span><span class="p">.</span><span class="n">active_attribute</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">g</span><span class="p">.</span><span class="n">active_attribute_id</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">current_attribute_id</span><span class="p">;</span>
        <span class="n">g</span><span class="p">.</span><span class="n">interactive_node_idx</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">current_node_idx</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">g</span><span class="p">.</span><span class="n">current_pin_idx</span><span class="p">];</span>
    <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">g</span><span class="p">.</span><span class="n">current_node_idx</span><span class="p">];</span>
    <span class="n">pin</span><span class="p">.</span><span class="n">attribute_rect</span> <span class="o">=</span> <span class="n">get_item_rect</span><span class="p">();</span>
    <span class="n">node</span><span class="p">.</span><span class="n">pin_indices</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_pin_idx</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">}</span> <span class="c1">// namespace</span>

<span class="c1">// [SECTION] API implementation</span>

<span class="n">IO</span><span class="o">::</span><span class="n">EmulateThreeButtonMouse</span><span class="o">::</span><span class="n">EmulateThreeButtonMouse</span><span class="p">()</span> <span class="o">:</span> <span class="n">enabled</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span> <span class="n">modifier</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{}</span>

<span class="n">IO</span><span class="o">::</span><span class="n">LinkDetachWithModifierClick</span><span class="o">::</span><span class="n">LinkDetachWithModifierClick</span><span class="p">()</span> <span class="o">:</span> <span class="n">modifier</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{}</span>

<span class="n">IO</span><span class="o">::</span><span class="n">IO</span><span class="p">()</span> <span class="o">:</span> <span class="n">emulate_three_button_mouse</span><span class="p">(),</span> <span class="n">link_detach_with_modifier_click</span><span class="p">()</span> <span class="p">{}</span>

<span class="n">Style</span><span class="o">::</span><span class="n">Style</span><span class="p">()</span>
    <span class="o">:</span> <span class="n">grid_spacing</span><span class="p">(</span><span class="mf">32.f</span><span class="p">),</span> <span class="n">node_corner_rounding</span><span class="p">(</span><span class="mf">4.f</span><span class="p">),</span> <span class="n">node_padding_horizontal</span><span class="p">(</span><span class="mf">8.f</span><span class="p">),</span>
      <span class="n">node_padding_vertical</span><span class="p">(</span><span class="mf">8.f</span><span class="p">),</span> <span class="n">node_border_thickness</span><span class="p">(</span><span class="mf">1.f</span><span class="p">),</span> <span class="n">link_thickness</span><span class="p">(</span><span class="mf">3.f</span><span class="p">),</span>
      <span class="n">link_line_segments_per_length</span><span class="p">(</span><span class="mf">0.1f</span><span class="p">),</span> <span class="n">link_hover_distance</span><span class="p">(</span><span class="mf">10.f</span><span class="p">),</span> <span class="n">pin_circle_radius</span><span class="p">(</span><span class="mf">4.f</span><span class="p">),</span>
      <span class="n">pin_quad_side_length</span><span class="p">(</span><span class="mf">7.f</span><span class="p">),</span> <span class="n">pin_triangle_side_length</span><span class="p">(</span><span class="mf">9.5</span><span class="p">),</span> <span class="n">pin_line_thickness</span><span class="p">(</span><span class="mf">1.f</span><span class="p">),</span>
      <span class="n">pin_hover_radius</span><span class="p">(</span><span class="mf">10.f</span><span class="p">),</span> <span class="n">pin_offset</span><span class="p">(</span><span class="mf">0.f</span><span class="p">),</span>
      <span class="n">flags</span><span class="p">(</span><span class="n">StyleFlags</span><span class="p">(</span><span class="n">StyleFlags_NodeOutline</span> <span class="o">|</span> <span class="n">StyleFlags_GridLines</span><span class="p">)),</span> <span class="n">colors</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">EditorContext</span><span class="o">*</span> <span class="n">EditorContextCreate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">void</span><span class="o">*</span> <span class="n">mem</span> <span class="o">=</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">MemAlloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">EditorContext</span><span class="p">));</span>
    <span class="k">new</span> <span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="n">EditorContext</span><span class="p">();</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">EditorContext</span><span class="o">*</span><span class="p">)</span><span class="n">mem</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">EditorContextFree</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">*</span> <span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ctx</span><span class="o">-&gt;~</span><span class="n">EditorContext</span><span class="p">();</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">MemFree</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">EditorContextSet</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">*</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">{</span> <span class="n">g</span><span class="p">.</span><span class="n">editor_ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span> <span class="p">}</span>

<span class="n">ImVec2</span> <span class="n">EditorContextGetPanning</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">editor</span><span class="p">.</span><span class="n">panning</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">EditorContextResetPanning</span><span class="p">(</span><span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="n">editor</span><span class="p">.</span><span class="n">panning</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">EditorContextMoveToNode</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">node_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">object_pool_find_or_create_object</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">node_id</span><span class="p">);</span>

    <span class="n">editor</span><span class="p">.</span><span class="n">panning</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">node</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
    <span class="n">editor</span><span class="p">.</span><span class="n">panning</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">node</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Initialize</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">g</span><span class="p">.</span><span class="n">canvas_origin_screen_space</span> <span class="o">=</span> <span class="n">ImVec2</span><span class="p">(</span><span class="mf">0.0f</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">canvas_rect_screen_space</span> <span class="o">=</span> <span class="n">ImRect</span><span class="p">(</span><span class="n">ImVec2</span><span class="p">(</span><span class="mf">0.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">),</span> <span class="n">ImVec2</span><span class="p">(</span><span class="mf">0.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">));</span>
    <span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">=</span> <span class="n">Scope_None</span><span class="p">;</span>

    <span class="n">g</span><span class="p">.</span><span class="n">current_pin_idx</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
    <span class="n">g</span><span class="p">.</span><span class="n">current_node_idx</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>

    <span class="n">g</span><span class="p">.</span><span class="n">default_editor_ctx</span> <span class="o">=</span> <span class="n">EditorContextCreate</span><span class="p">();</span>
    <span class="n">EditorContextSet</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">default_editor_ctx</span><span class="p">);</span>

    <span class="k">const</span> <span class="n">ImGuiIO</span><span class="o">&amp;</span> <span class="n">io</span> <span class="o">=</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">GetIO</span><span class="p">();</span>
    <span class="n">g</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">emulate_three_button_mouse</span><span class="p">.</span><span class="n">modifier</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">io</span><span class="p">.</span><span class="n">KeyAlt</span><span class="p">;</span>

    <span class="n">g</span><span class="p">.</span><span class="n">current_attribute_flags</span> <span class="o">=</span> <span class="n">AttributeFlags_None</span><span class="p">;</span>
    <span class="n">g</span><span class="p">.</span><span class="n">attribute_flag_stack</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_attribute_flags</span><span class="p">);</span>

    <span class="n">StyleColorsDark</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Shutdown</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">EditorContextFree</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">default_editor_ctx</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">editor_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">g</span><span class="p">.</span><span class="n">default_editor_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">IO</span><span class="o">&amp;</span> <span class="n">GetIO</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">g</span><span class="p">.</span><span class="n">io</span><span class="p">;</span> <span class="p">}</span>

<span class="n">Style</span><span class="o">&amp;</span> <span class="n">GetStyle</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">;</span> <span class="p">}</span>

<span class="kt">void</span> <span class="n">StyleColorsDark</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeBackground</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeBackgroundHovered</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeBackgroundSelected</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeOutline</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="c1">// title bar colors match ImGui&#39;s titlebg colors</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_TitleBar</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">41</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_TitleBarHovered</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">66</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_TitleBarSelected</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">66</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="c1">// link colors match ImGui&#39;s slider grab colors</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_Link</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">61</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_LinkHovered</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">66</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_LinkSelected</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">66</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="c1">// pin colors match ImGui&#39;s button colors</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_Pin</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">53</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">180</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_PinHovered</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">53</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>

    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_BoxSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">61</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_BoxSelectorOutline</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">61</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">150</span><span class="p">);</span>

    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_GridBackground</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_GridLine</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">StyleColorsClassic</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeBackground</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeBackgroundHovered</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeBackgroundSelected</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">75</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeOutline</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_TitleBar</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">69</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_TitleBarHovered</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">82</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_TitleBarSelected</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">82</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_Link</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_LinkHovered</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">105</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">153</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_LinkSelected</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">105</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">153</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_Pin</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">89</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">170</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_PinHovered</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">102</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_BoxSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">82</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_BoxSelectorOutline</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">82</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_GridBackground</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_GridLine</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">StyleColorsLight</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeBackground</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeBackgroundHovered</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeBackgroundSelected</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeOutline</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_TitleBar</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">248</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_TitleBarHovered</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">209</span><span class="p">,</span> <span class="mi">209</span><span class="p">,</span> <span class="mi">209</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_TitleBarSelected</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">209</span><span class="p">,</span> <span class="mi">209</span><span class="p">,</span> <span class="mi">209</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="c1">// original imgui values: 66, 150, 250</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_Link</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">66</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
    <span class="c1">// original imgui values: 117, 138, 204</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_LinkHovered</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">66</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">242</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_LinkSelected</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">66</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">242</span><span class="p">);</span>
    <span class="c1">// original imgui values: 66, 150, 250</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_Pin</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">66</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">160</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_PinHovered</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">66</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_BoxSelector</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_BoxSelectorOutline</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">150</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_GridBackground</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">225</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_GridLine</span><span class="p">]</span> <span class="o">=</span> <span class="n">IM_COL32</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">StyleFlags</span><span class="p">(</span><span class="n">StyleFlags_None</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BeginNodeEditor</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_None</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">=</span> <span class="n">Scope_Editor</span><span class="p">;</span>

    <span class="c1">// Reset state from previous pass</span>

    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="n">object_pool_reset</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">);</span>
    <span class="n">object_pool_reset</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">);</span>
    <span class="n">object_pool_reset</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">);</span>

    <span class="n">g</span><span class="p">.</span><span class="n">hovered_node_idx</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
    <span class="n">g</span><span class="p">.</span><span class="n">interactive_node_idx</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
    <span class="n">g</span><span class="p">.</span><span class="n">hovered_link_idx</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
    <span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
    <span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_flags</span> <span class="o">=</span> <span class="n">AttributeFlags_None</span><span class="p">;</span>
    <span class="n">g</span><span class="p">.</span><span class="n">deleted_link_idx</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
    <span class="n">g</span><span class="p">.</span><span class="n">snap_link_idx</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>

    <span class="n">g</span><span class="p">.</span><span class="n">node_indices_overlapping_with_mouse</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

    <span class="n">g</span><span class="p">.</span><span class="n">element_state_change</span> <span class="o">=</span> <span class="n">ElementStateChange_None</span><span class="p">;</span>

    <span class="n">g</span><span class="p">.</span><span class="n">mouse_pos</span> <span class="o">=</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">GetIO</span><span class="p">().</span><span class="n">MousePos</span><span class="p">;</span>
    <span class="n">g</span><span class="p">.</span><span class="n">left_mouse_clicked</span> <span class="o">=</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">IsMouseClicked</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">left_mouse_released</span> <span class="o">=</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">IsMouseReleased</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">middle_mouse_clicked</span> <span class="o">=</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">IsMouseClicked</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">left_mouse_dragging</span> <span class="o">=</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">IsMouseDragging</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">middle_mouse_dragging</span> <span class="o">=</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">IsMouseDragging</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.0f</span><span class="p">);</span>

    <span class="n">g</span><span class="p">.</span><span class="n">active_attribute</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="n">ImGui</span><span class="o">::</span><span class="n">BeginGroup</span><span class="p">();</span>
    <span class="p">{</span>
        <span class="n">ImGui</span><span class="o">::</span><span class="n">PushStyleVar</span><span class="p">(</span><span class="n">ImGuiStyleVar_FramePadding</span><span class="p">,</span> <span class="n">ImVec2</span><span class="p">(</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">));</span>
        <span class="n">ImGui</span><span class="o">::</span><span class="n">PushStyleVar</span><span class="p">(</span><span class="n">ImGuiStyleVar_WindowPadding</span><span class="p">,</span> <span class="n">ImVec2</span><span class="p">(</span><span class="mf">0.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">));</span>
        <span class="n">ImGui</span><span class="o">::</span><span class="n">PushStyleColor</span><span class="p">(</span><span class="n">ImGuiCol_ChildBg</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_GridBackground</span><span class="p">]);</span>
        <span class="n">ImGui</span><span class="o">::</span><span class="n">BeginChild</span><span class="p">(</span>
            <span class="s">&quot;scrolling_region&quot;</span><span class="p">,</span>
            <span class="n">ImVec2</span><span class="p">(</span><span class="mf">0.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">),</span>
            <span class="nb">true</span><span class="p">,</span>
            <span class="n">ImGuiWindowFlags_NoScrollbar</span> <span class="o">|</span> <span class="n">ImGuiWindowFlags_NoMove</span> <span class="o">|</span>
                <span class="n">ImGuiWindowFlags_NoScrollWithMouse</span><span class="p">);</span>
        <span class="n">g</span><span class="p">.</span><span class="n">canvas_origin_screen_space</span> <span class="o">=</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">GetCursorScreenPos</span><span class="p">();</span>

        <span class="c1">// NOTE: we have to fetch the canvas draw list *after* we call</span>
        <span class="c1">// BeginChild(), otherwise the ImGui UI elements are going to be</span>
        <span class="c1">// rendered into the parent window draw list.</span>
        <span class="n">draw_list_set</span><span class="p">(</span><span class="n">ImGui</span><span class="o">::</span><span class="n">GetWindowDrawList</span><span class="p">());</span>

        <span class="p">{</span>
            <span class="k">const</span> <span class="n">ImVec2</span> <span class="n">canvas_size</span> <span class="o">=</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">GetWindowSize</span><span class="p">();</span>
            <span class="n">g</span><span class="p">.</span><span class="n">canvas_rect_screen_space</span> <span class="o">=</span> <span class="n">ImRect</span><span class="p">(</span>
                <span class="n">editor_space_to_screen_space</span><span class="p">(</span><span class="n">ImVec2</span><span class="p">(</span><span class="mf">0.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">)),</span>
                <span class="n">editor_space_to_screen_space</span><span class="p">(</span><span class="n">canvas_size</span><span class="p">));</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">StyleFlags_GridLines</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">draw_grid</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">canvas_size</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">EndNodeEditor</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_Editor</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">=</span> <span class="n">Scope_None</span><span class="p">;</span>

    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>

    <span class="c1">// Resolve which node is actually on top and being hovered. This needs to be done before any of</span>
    <span class="c1">// the nodes can be rendered.</span>

    <span class="n">g</span><span class="p">.</span><span class="n">hovered_node_idx</span> <span class="o">=</span> <span class="n">resolve_hovered_node</span><span class="p">(</span><span class="n">editor</span><span class="p">);</span>

    <span class="c1">// Render the nodes and resolve which pin the mouse is hovering over. The hovered pin is needed</span>
    <span class="c1">// for handling click interactions.</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">node_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">node_idx</span> <span class="o">&lt;</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">node_idx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">in_use</span><span class="p">[</span><span class="n">node_idx</span><span class="p">])</span>
        <span class="p">{</span>
            <span class="n">draw_list_activate_node_background</span><span class="p">(</span><span class="n">node_idx</span><span class="p">);</span>
            <span class="n">draw_node</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">node_idx</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// In order to render the links underneath the nodes, we want to first select the bottom draw</span>
    <span class="c1">// channel.</span>
    <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">ChannelsSetCurrent</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">link_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">link_idx</span> <span class="o">&lt;</span> <span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">link_idx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">in_use</span><span class="p">[</span><span class="n">link_idx</span><span class="p">])</span>
        <span class="p">{</span>
            <span class="n">draw_link</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">link_idx</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Render the click interaction UI elements (partial links, box selector) on top of everything</span>
    <span class="c1">// else.</span>

    <span class="n">draw_list_append_click_interaction_channel</span><span class="p">();</span>
    <span class="n">draw_list_activate_click_interaction_channel</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">left_mouse_clicked</span> <span class="o">||</span> <span class="n">g</span><span class="p">.</span><span class="n">middle_mouse_clicked</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">begin_canvas_interaction</span><span class="p">(</span><span class="n">editor</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">click_interaction_update</span><span class="p">(</span><span class="n">editor</span><span class="p">);</span>

    <span class="c1">// At this point, draw commands have been issued for all nodes (and pins). Update the node pool</span>
    <span class="c1">// to detect unused node slots and remove those indices from the depth stack before sorting the</span>
    <span class="c1">// node draw commands by depth.</span>
    <span class="n">object_pool_update</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">);</span>
    <span class="n">object_pool_update</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">);</span>

    <span class="n">draw_list_sort_channels_by_depth</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">node_depth_order</span><span class="p">);</span>

    <span class="c1">// After the links have been rendered, the link pool can be updated as well.</span>
    <span class="n">object_pool_update</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">);</span>

    <span class="c1">// Finally, merge the draw channels</span>
    <span class="n">g</span><span class="p">.</span><span class="n">canvas_draw_list</span><span class="o">-&gt;</span><span class="n">ChannelsMerge</span><span class="p">();</span>

    <span class="c1">// pop style</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">EndChild</span><span class="p">();</span>      <span class="c1">// end scrolling region</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">PopStyleColor</span><span class="p">();</span> <span class="c1">// pop child window background color</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">PopStyleVar</span><span class="p">();</span>   <span class="c1">// pop window padding</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">PopStyleVar</span><span class="p">();</span>   <span class="c1">// pop frame padding</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">EndGroup</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BeginNode</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">node_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Remember to call BeginNodeEditor before calling BeginNode</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_Editor</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">=</span> <span class="n">Scope_Node</span><span class="p">;</span>

    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>

    <span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span> <span class="o">=</span> <span class="n">object_pool_find_or_create_index</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">node_id</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">current_node_idx</span> <span class="o">=</span> <span class="n">node_idx</span><span class="p">;</span>

    <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">node_idx</span><span class="p">];</span>
    <span class="n">node</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">background</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeBackground</span><span class="p">];</span>
    <span class="n">node</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">background_hovered</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeBackgroundHovered</span><span class="p">];</span>
    <span class="n">node</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">background_selected</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeBackgroundSelected</span><span class="p">];</span>
    <span class="n">node</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">outline</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_NodeOutline</span><span class="p">];</span>
    <span class="n">node</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">titlebar</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_TitleBar</span><span class="p">];</span>
    <span class="n">node</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">titlebar_hovered</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_TitleBarHovered</span><span class="p">];</span>
    <span class="n">node</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">titlebar_selected</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_TitleBarSelected</span><span class="p">];</span>
    <span class="n">node</span><span class="p">.</span><span class="n">layout_style</span><span class="p">.</span><span class="n">corner_rounding</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">node_corner_rounding</span><span class="p">;</span>
    <span class="n">node</span><span class="p">.</span><span class="n">layout_style</span><span class="p">.</span><span class="n">padding</span> <span class="o">=</span>
        <span class="n">ImVec2</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">node_padding_horizontal</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">node_padding_vertical</span><span class="p">);</span>
    <span class="n">node</span><span class="p">.</span><span class="n">layout_style</span><span class="p">.</span><span class="n">border_thickness</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">node_border_thickness</span><span class="p">;</span>

    <span class="c1">// ImGui::SetCursorPos sets the cursor position, local to the current widget</span>
    <span class="c1">// (in this case, the child object started in BeginNodeEditor). Use</span>
    <span class="c1">// ImGui::SetCursorScreenPos to set the screen space coordinates directly.</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">SetCursorPos</span><span class="p">(</span><span class="n">grid_space_to_editor_space</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">get_node_title_bar_origin</span><span class="p">(</span><span class="n">node</span><span class="p">)));</span>

    <span class="n">draw_list_add_node</span><span class="p">(</span><span class="n">node_idx</span><span class="p">);</span>
    <span class="n">draw_list_activate_current_node_foreground</span><span class="p">();</span>

    <span class="n">ImGui</span><span class="o">::</span><span class="n">PushID</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">BeginGroup</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">EndNode</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_Node</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">=</span> <span class="n">Scope_Editor</span><span class="p">;</span>

    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>

    <span class="c1">// The node&#39;s rectangle depends on the ImGui UI group size.</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">EndGroup</span><span class="p">();</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">PopID</span><span class="p">();</span>

    <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">g</span><span class="p">.</span><span class="n">current_node_idx</span><span class="p">];</span>
    <span class="n">node</span><span class="p">.</span><span class="n">rect</span> <span class="o">=</span> <span class="n">get_item_rect</span><span class="p">();</span>
    <span class="n">node</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">Expand</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">layout_style</span><span class="p">.</span><span class="n">padding</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">mouse_pos</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">g</span><span class="p">.</span><span class="n">node_indices_overlapping_with_mouse</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_node_idx</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">ImVec2</span> <span class="n">GetNodeDimensions</span><span class="p">(</span><span class="kt">int</span> <span class="n">node_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span> <span class="o">=</span> <span class="n">object_pool_find</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">node_id</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">node_idx</span> <span class="o">!=</span> <span class="mi">-1</span><span class="p">);</span> <span class="c1">// invalid node_id</span>
    <span class="k">const</span> <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">node_idx</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">node</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">GetSize</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BeginNodeTitleBar</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_Node</span><span class="p">);</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">BeginGroup</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">EndNodeTitleBar</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_Node</span><span class="p">);</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">EndGroup</span><span class="p">();</span>

    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">g</span><span class="p">.</span><span class="n">current_node_idx</span><span class="p">];</span>
    <span class="n">node</span><span class="p">.</span><span class="n">title_bar_content_rect</span> <span class="o">=</span> <span class="n">get_item_rect</span><span class="p">();</span>

    <span class="n">ImGui</span><span class="o">::</span><span class="n">ItemAdd</span><span class="p">(</span><span class="n">get_node_title_rect</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">ImGui</span><span class="o">::</span><span class="n">GetID</span><span class="p">(</span><span class="s">&quot;title_bar&quot;</span><span class="p">));</span>

    <span class="n">ImGui</span><span class="o">::</span><span class="n">SetCursorPos</span><span class="p">(</span><span class="n">grid_space_to_editor_space</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">get_node_content_origin</span><span class="p">(</span><span class="n">node</span><span class="p">)));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BeginInputAttribute</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">const</span> <span class="n">PinShape</span> <span class="n">shape</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">begin_pin_attribute</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">AttributeType_Input</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">current_node_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">EndInputAttribute</span><span class="p">()</span> <span class="p">{</span> <span class="n">end_pin_attribute</span><span class="p">();</span> <span class="p">}</span>

<span class="kt">void</span> <span class="n">BeginOutputAttribute</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">const</span> <span class="n">PinShape</span> <span class="n">shape</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">begin_pin_attribute</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">AttributeType_Output</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="n">current_node_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">EndOutputAttribute</span><span class="p">()</span> <span class="p">{</span> <span class="n">end_pin_attribute</span><span class="p">();</span> <span class="p">}</span>

<span class="kt">void</span> <span class="n">BeginStaticAttribute</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Make sure to call BeginNode() before calling BeginAttribute()</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_Node</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">=</span> <span class="n">Scope_Attribute</span><span class="p">;</span>

    <span class="n">g</span><span class="p">.</span><span class="n">current_attribute_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

    <span class="n">ImGui</span><span class="o">::</span><span class="n">BeginGroup</span><span class="p">();</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">PushID</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">EndStaticAttribute</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Make sure to call BeginNode() before calling BeginAttribute()</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_Attribute</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">=</span> <span class="n">Scope_Node</span><span class="p">;</span>

    <span class="n">ImGui</span><span class="o">::</span><span class="n">PopID</span><span class="p">();</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">EndGroup</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ImGui</span><span class="o">::</span><span class="n">IsItemActive</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">g</span><span class="p">.</span><span class="n">active_attribute</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">g</span><span class="p">.</span><span class="n">active_attribute_id</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">current_attribute_id</span><span class="p">;</span>
        <span class="n">g</span><span class="p">.</span><span class="n">interactive_node_idx</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">current_node_idx</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">PushAttributeFlag</span><span class="p">(</span><span class="n">AttributeFlags</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">g</span><span class="p">.</span><span class="n">current_attribute_flags</span> <span class="o">|=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">attribute_flag_stack</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_attribute_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">PopAttributeFlag</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// PopAttributeFlag called without a matching PushAttributeFlag!</span>
    <span class="c1">// The bottom value is always the default value, pushed in Initialize().</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">attribute_flag_stack</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">g</span><span class="p">.</span><span class="n">attribute_flag_stack</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
    <span class="n">g</span><span class="p">.</span><span class="n">current_attribute_flags</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">attribute_flag_stack</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Link</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">start_attr_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">end_attr_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_Editor</span><span class="p">);</span>

    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="n">LinkData</span><span class="o">&amp;</span> <span class="n">link</span> <span class="o">=</span> <span class="n">object_pool_find_or_create_object</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
    <span class="n">link</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">link</span><span class="p">.</span><span class="n">start_pin_idx</span> <span class="o">=</span> <span class="n">object_pool_find_or_create_index</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">,</span> <span class="n">start_attr_id</span><span class="p">);</span>
    <span class="n">link</span><span class="p">.</span><span class="n">end_pin_idx</span> <span class="o">=</span> <span class="n">object_pool_find_or_create_index</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">,</span> <span class="n">end_attr_id</span><span class="p">);</span>
    <span class="n">link</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_Link</span><span class="p">];</span>
    <span class="n">link</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">hovered</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_LinkHovered</span><span class="p">];</span>
    <span class="n">link</span><span class="p">.</span><span class="n">color_style</span><span class="p">.</span><span class="n">selected</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ColorStyle_LinkSelected</span><span class="p">];</span>

    <span class="c1">// Check if this link was created by the current link event</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">==</span> <span class="n">ClickInteractionType_LinkCreation</span> <span class="o">&amp;&amp;</span>
         <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">link</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AttributeFlags_EnableLinkCreationOnSnap</span> <span class="o">&amp;&amp;</span>
         <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">start_pin_idx</span> <span class="o">==</span> <span class="n">link</span><span class="p">.</span><span class="n">start_pin_idx</span> <span class="o">&amp;&amp;</span>
         <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">end_pin_idx</span> <span class="o">==</span> <span class="n">link</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">start_pin_idx</span> <span class="o">==</span> <span class="n">link</span><span class="p">.</span><span class="n">end_pin_idx</span> <span class="o">&amp;&amp;</span>
         <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">end_pin_idx</span> <span class="o">==</span> <span class="n">link</span><span class="p">.</span><span class="n">start_pin_idx</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">g</span><span class="p">.</span><span class="n">snap_link_idx</span> <span class="o">=</span> <span class="n">object_pool_find_or_create_index</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">PushColorStyle</span><span class="p">(</span><span class="n">ColorStyle</span> <span class="n">item</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">g</span><span class="p">.</span><span class="n">color_modifier_stack</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ColorStyleElement</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">item</span><span class="p">));</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">PopColorStyle</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">color_modifier_stack</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">ColorStyleElement</span> <span class="n">elem</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">color_modifier_stack</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">colors</span><span class="p">[</span><span class="n">elem</span><span class="p">.</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span><span class="p">.</span><span class="n">color</span><span class="p">;</span>
    <span class="n">g</span><span class="p">.</span><span class="n">color_modifier_stack</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">float</span><span class="o">&amp;</span> <span class="n">lookup_style_var</span><span class="p">(</span><span class="k">const</span> <span class="n">StyleVar</span> <span class="n">item</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// TODO: once the switch gets too big and unwieldy to work with, we could do</span>
    <span class="c1">// a byte-offset lookup into the Style struct, using the StyleVar as an</span>
    <span class="c1">// index. This is how ImGui does it.</span>
    <span class="kt">float</span><span class="o">*</span> <span class="n">style_var</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="nl">StyleVar_GridSpacing</span><span class="p">:</span>
        <span class="n">style_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">grid_spacing</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">StyleVar_NodeCornerRounding</span><span class="p">:</span>
        <span class="n">style_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">node_corner_rounding</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">StyleVar_NodePaddingHorizontal</span><span class="p">:</span>
        <span class="n">style_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">node_padding_horizontal</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">StyleVar_NodePaddingVertical</span><span class="p">:</span>
        <span class="n">style_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">node_padding_vertical</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">StyleVar_NodeBorderThickness</span><span class="p">:</span>
        <span class="n">style_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">node_border_thickness</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">StyleVar_LinkThickness</span><span class="p">:</span>
        <span class="n">style_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">link_thickness</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">StyleVar_LinkLineSegmentsPerLength</span><span class="p">:</span>
        <span class="n">style_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">link_line_segments_per_length</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">StyleVar_LinkHoverDistance</span><span class="p">:</span>
        <span class="n">style_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">link_hover_distance</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">StyleVar_PinCircleRadius</span><span class="p">:</span>
        <span class="n">style_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_circle_radius</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">StyleVar_PinQuadSideLength</span><span class="p">:</span>
        <span class="n">style_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_quad_side_length</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">StyleVar_PinTriangleSideLength</span><span class="p">:</span>
        <span class="n">style_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_triangle_side_length</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">StyleVar_PinLineThickness</span><span class="p">:</span>
        <span class="n">style_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_line_thickness</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">StyleVar_PinHoverRadius</span><span class="p">:</span>
        <span class="n">style_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_hover_radius</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">StyleVar_PinOffset</span><span class="p">:</span>
        <span class="n">style_var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">pin_offset</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="s">&quot;Invalid StyleVar value!&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">*</span><span class="n">style_var</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">PushStyleVar</span><span class="p">(</span><span class="k">const</span> <span class="n">StyleVar</span> <span class="n">item</span><span class="p">,</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">float</span><span class="o">&amp;</span> <span class="n">style_var</span> <span class="o">=</span> <span class="n">lookup_style_var</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style_modifier_stack</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">StyleElement</span><span class="p">(</span><span class="n">style_var</span><span class="p">,</span> <span class="n">item</span><span class="p">));</span>
    <span class="n">style_var</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">PopStyleVar</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">style_modifier_stack</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">StyleElement</span> <span class="n">style_elem</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">style_modifier_stack</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
    <span class="n">g</span><span class="p">.</span><span class="n">style_modifier_stack</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
    <span class="kt">float</span><span class="o">&amp;</span> <span class="n">style_var</span> <span class="o">=</span> <span class="n">lookup_style_var</span><span class="p">(</span><span class="n">style_elem</span><span class="p">.</span><span class="n">item</span><span class="p">);</span>
    <span class="n">style_var</span> <span class="o">=</span> <span class="n">style_elem</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SetNodeScreenSpacePos</span><span class="p">(</span><span class="kt">int</span> <span class="n">node_id</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">screen_space_pos</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">object_pool_find_or_create_object</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">node_id</span><span class="p">);</span>
    <span class="n">node</span><span class="p">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">screen_space_to_grid_space</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">screen_space_pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SetNodeEditorSpacePos</span><span class="p">(</span><span class="kt">int</span> <span class="n">node_id</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">editor_space_pos</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">object_pool_find_or_create_object</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">node_id</span><span class="p">);</span>
    <span class="n">node</span><span class="p">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">editor_space_to_grid_space</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">editor_space_pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SetNodeGridSpacePos</span><span class="p">(</span><span class="kt">int</span> <span class="n">node_id</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImVec2</span><span class="o">&amp;</span> <span class="n">grid_pos</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">object_pool_find_or_create_object</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">node_id</span><span class="p">);</span>
    <span class="n">node</span><span class="p">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">grid_pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SetNodeDraggable</span><span class="p">(</span><span class="kt">int</span> <span class="n">node_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">draggable</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">object_pool_find_or_create_object</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">node_id</span><span class="p">);</span>
    <span class="n">node</span><span class="p">.</span><span class="n">draggable</span> <span class="o">=</span> <span class="n">draggable</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">ImVec2</span> <span class="n">GetNodeScreenSpacePos</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">node_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span> <span class="o">=</span> <span class="n">object_pool_find</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">node_id</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">node_idx</span> <span class="o">!=</span> <span class="mi">-1</span><span class="p">);</span>
    <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">node_idx</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">grid_space_to_screen_space</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">origin</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">ImVec2</span> <span class="n">GetNodeEditorSpacePos</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">node_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span> <span class="o">=</span> <span class="n">object_pool_find</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">node_id</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">node_idx</span> <span class="o">!=</span> <span class="mi">-1</span><span class="p">);</span>
    <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">node_idx</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">grid_space_to_editor_space</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">origin</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">ImVec2</span> <span class="n">GetNodeGridSpacePos</span><span class="p">(</span><span class="kt">int</span> <span class="n">node_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span> <span class="o">=</span> <span class="n">object_pool_find</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">node_id</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">node_idx</span> <span class="o">!=</span> <span class="mi">-1</span><span class="p">);</span>
    <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">node_idx</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">node</span><span class="p">.</span><span class="n">origin</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">IsEditorHovered</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">mouse_in_canvas</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">IsNodeHovered</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">node_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_None</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">node_id</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">const</span> <span class="kt">bool</span> <span class="n">is_hovered</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">hovered_node_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_hovered</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
        <span class="o">*</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">g</span><span class="p">.</span><span class="n">hovered_node_idx</span><span class="p">.</span><span class="n">value</span><span class="p">()].</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">is_hovered</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">IsLinkHovered</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">link_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_None</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">link_id</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">const</span> <span class="kt">bool</span> <span class="n">is_hovered</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">hovered_link_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_hovered</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
        <span class="o">*</span><span class="n">link_id</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">g</span><span class="p">.</span><span class="n">hovered_link_idx</span><span class="p">.</span><span class="n">value</span><span class="p">()].</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">is_hovered</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">IsPinHovered</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_None</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">attr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">const</span> <span class="kt">bool</span> <span class="n">is_hovered</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_hovered</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
        <span class="o">*</span><span class="n">attr</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">g</span><span class="p">.</span><span class="n">hovered_pin_idx</span><span class="p">.</span><span class="n">value</span><span class="p">()].</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">is_hovered</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">NumSelectedNodes</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_None</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">editor</span><span class="p">.</span><span class="n">selected_node_indices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">NumSelectedLinks</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_None</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">editor</span><span class="p">.</span><span class="n">selected_link_indices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">GetSelectedNodes</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">node_ids</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">node_ids</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">editor</span><span class="p">.</span><span class="n">selected_node_indices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">selected_node_indices</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">node_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">node_idx</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">GetSelectedLinks</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">link_ids</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">link_ids</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">editor</span><span class="p">.</span><span class="n">selected_link_indices</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">link_idx</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">selected_link_indices</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">link_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">link_idx</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">ClearNodeSelection</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="n">editor</span><span class="p">.</span><span class="n">selected_node_indices</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">ClearLinkSelection</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
    <span class="n">editor</span><span class="p">.</span><span class="n">selected_link_indices</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">IsAttributeActive</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">((</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">&amp;</span> <span class="n">Scope_Node</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g</span><span class="p">.</span><span class="n">active_attribute</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">g</span><span class="p">.</span><span class="n">active_attribute_id</span> <span class="o">==</span> <span class="n">g</span><span class="p">.</span><span class="n">current_attribute_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">IsAnyAttributeActive</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">attribute_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">((</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Scope_Node</span> <span class="o">|</span> <span class="n">Scope_Attribute</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g</span><span class="p">.</span><span class="n">active_attribute</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">attribute_id</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">*</span><span class="n">attribute_id</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">active_attribute_id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">IsLinkStarted</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">started_at_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Call this function after EndNodeEditor()!</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_None</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">started_at_id</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">const</span> <span class="kt">bool</span> <span class="n">is_started</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">element_state_change</span> <span class="o">&amp;</span> <span class="n">ElementStateChange_LinkStarted</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_started</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">pin_idx</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">start_pin_idx</span><span class="p">;</span>
        <span class="o">*</span><span class="n">started_at_id</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">is_started</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">IsLinkDropped</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">started_at_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">including_detached_links</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Call this function after EndNodeEditor()!</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_None</span><span class="p">);</span>

    <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>

    <span class="k">const</span> <span class="kt">bool</span> <span class="n">link_dropped</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">element_state_change</span> <span class="o">&amp;</span> <span class="n">ElementStateChange_LinkDropped</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                              <span class="p">(</span><span class="n">including_detached_links</span> <span class="o">||</span>
                               <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">link_creation_type</span> <span class="o">!=</span>
                                   <span class="n">LinkCreationType_FromDetach</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">link_dropped</span> <span class="o">&amp;&amp;</span> <span class="n">started_at_id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">pin_idx</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">start_pin_idx</span><span class="p">;</span>
        <span class="o">*</span><span class="n">started_at_id</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">pin_idx</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">link_dropped</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">IsLinkCreated</span><span class="p">(</span>
    <span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">started_at_pin_id</span><span class="p">,</span>
    <span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">ended_at_pin_id</span><span class="p">,</span>
    <span class="kt">bool</span><span class="o">*</span> <span class="k">const</span> <span class="n">created_from_snap</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_None</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">started_at_pin_id</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">ended_at_pin_id</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">const</span> <span class="kt">bool</span> <span class="n">is_created</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">element_state_change</span> <span class="o">&amp;</span> <span class="n">ElementStateChange_LinkCreated</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">is_created</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">start_idx</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">start_pin_idx</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
        <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">start_pin</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">start_idx</span><span class="p">];</span>
        <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">end_pin</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">end_idx</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">start_pin</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">AttributeType_Output</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="o">*</span><span class="n">started_at_pin_id</span> <span class="o">=</span> <span class="n">start_pin</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
            <span class="o">*</span><span class="n">ended_at_pin_id</span> <span class="o">=</span> <span class="n">end_pin</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="o">*</span><span class="n">started_at_pin_id</span> <span class="o">=</span> <span class="n">end_pin</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
            <span class="o">*</span><span class="n">ended_at_pin_id</span> <span class="o">=</span> <span class="n">start_pin</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">created_from_snap</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="o">*</span><span class="n">created_from_snap</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">==</span> <span class="n">ClickInteractionType_LinkCreation</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">is_created</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">IsLinkCreated</span><span class="p">(</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">started_at_node_id</span><span class="p">,</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">started_at_pin_id</span><span class="p">,</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">ended_at_node_id</span><span class="p">,</span>
    <span class="kt">int</span><span class="o">*</span> <span class="n">ended_at_pin_id</span><span class="p">,</span>
    <span class="kt">bool</span><span class="o">*</span> <span class="n">created_from_snap</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_None</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">started_at_node_id</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">started_at_pin_id</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">ended_at_node_id</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">ended_at_pin_id</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">const</span> <span class="kt">bool</span> <span class="n">is_created</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">element_state_change</span> <span class="o">&amp;</span> <span class="n">ElementStateChange_LinkCreated</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">is_created</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">start_idx</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">start_pin_idx</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_state</span><span class="p">.</span><span class="n">link_creation</span><span class="p">.</span><span class="n">end_pin_idx</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
        <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">start_pin</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">start_idx</span><span class="p">];</span>
        <span class="k">const</span> <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">start_node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">start_pin</span><span class="p">.</span><span class="n">parent_node_idx</span><span class="p">];</span>
        <span class="k">const</span> <span class="n">PinData</span><span class="o">&amp;</span> <span class="n">end_pin</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">pins</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">end_idx</span><span class="p">];</span>
        <span class="k">const</span> <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">end_node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">end_pin</span><span class="p">.</span><span class="n">parent_node_idx</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">start_pin</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">AttributeType_Output</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="o">*</span><span class="n">started_at_pin_id</span> <span class="o">=</span> <span class="n">start_pin</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
            <span class="o">*</span><span class="n">started_at_node_id</span> <span class="o">=</span> <span class="n">start_node</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
            <span class="o">*</span><span class="n">ended_at_pin_id</span> <span class="o">=</span> <span class="n">end_pin</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
            <span class="o">*</span><span class="n">ended_at_node_id</span> <span class="o">=</span> <span class="n">end_node</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="o">*</span><span class="n">started_at_pin_id</span> <span class="o">=</span> <span class="n">end_pin</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
            <span class="o">*</span><span class="n">started_at_node_id</span> <span class="o">=</span> <span class="n">end_node</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
            <span class="o">*</span><span class="n">ended_at_pin_id</span> <span class="o">=</span> <span class="n">start_pin</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
            <span class="o">*</span><span class="n">ended_at_node_id</span> <span class="o">=</span> <span class="n">start_node</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">created_from_snap</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="o">*</span><span class="n">created_from_snap</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">click_interaction_type</span> <span class="o">==</span> <span class="n">ClickInteractionType_LinkCreation</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">is_created</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">IsLinkDestroyed</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">link_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">current_scope</span> <span class="o">==</span> <span class="n">Scope_None</span><span class="p">);</span>

    <span class="k">const</span> <span class="kt">bool</span> <span class="n">link_destroyed</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">deleted_link_idx</span><span class="p">.</span><span class="n">has_value</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">link_destroyed</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_context_get</span><span class="p">();</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">link_idx</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">deleted_link_idx</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
        <span class="o">*</span><span class="n">link_id</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">links</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">link_idx</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">link_destroyed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">namespace</span>
<span class="p">{</span>
<span class="kt">void</span> <span class="nf">node_line_handler</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;[node.%i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">node_idx</span> <span class="o">=</span> <span class="n">object_pool_find_or_create_index</span><span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
        <span class="n">g</span><span class="p">.</span><span class="n">current_node_idx</span> <span class="o">=</span> <span class="n">node_idx</span><span class="p">;</span>
        <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">node_idx</span><span class="p">];</span>
        <span class="n">node</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;origin=%i,%i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">g</span><span class="p">.</span><span class="n">current_node_idx</span><span class="p">];</span>
        <span class="n">node</span><span class="p">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">ImVec2</span><span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">y</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">editor_line_handler</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">sscanf</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;panning=%f,%f&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">editor</span><span class="p">.</span><span class="n">panning</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">editor</span><span class="p">.</span><span class="n">panning</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">}</span> <span class="c1">// namespace</span>

<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">SaveCurrentEditorStateToIniString</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span> <span class="k">const</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">SaveEditorStateToIniString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">editor_context_get</span><span class="p">(),</span> <span class="n">data_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">SaveEditorStateToIniString</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">EditorContext</span><span class="o">*</span> <span class="k">const</span> <span class="n">editor_ptr</span><span class="p">,</span>
    <span class="kt">size_t</span><span class="o">*</span> <span class="k">const</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">editor_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="o">*</span><span class="n">editor_ptr</span><span class="p">;</span>

    <span class="n">g</span><span class="p">.</span><span class="n">text_buffer</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="c1">// TODO: check to make sure that the estimate is the upper bound of element</span>
    <span class="n">g</span><span class="p">.</span><span class="n">text_buffer</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

    <span class="n">g</span><span class="p">.</span><span class="n">text_buffer</span><span class="p">.</span><span class="n">appendf</span><span class="p">(</span>
        <span class="s">&quot;[editor]</span><span class="se">\n</span><span class="s">panning=%i,%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">editor</span><span class="p">.</span><span class="n">panning</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">editor</span><span class="p">.</span><span class="n">panning</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">in_use</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="n">NodeData</span><span class="o">&amp;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">editor</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">g</span><span class="p">.</span><span class="n">text_buffer</span><span class="p">.</span><span class="n">appendf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">[node.%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
            <span class="n">g</span><span class="p">.</span><span class="n">text_buffer</span><span class="p">.</span><span class="n">appendf</span><span class="p">(</span><span class="s">&quot;origin=%i,%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">node</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">node</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">*</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">g</span><span class="p">.</span><span class="n">text_buffer</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">g</span><span class="p">.</span><span class="n">text_buffer</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">LoadCurrentEditorStateFromIniString</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">LoadEditorStateFromIniString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">editor_context_get</span><span class="p">(),</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">LoadEditorStateFromIniString</span><span class="p">(</span>
    <span class="n">EditorContext</span><span class="o">*</span> <span class="k">const</span> <span class="n">editor_ptr</span><span class="p">,</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">data</span><span class="p">,</span>
    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">==</span> <span class="mi">0u</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">EditorContext</span><span class="o">&amp;</span> <span class="n">editor</span> <span class="o">=</span> <span class="n">editor_ptr</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="n">editor_context_get</span><span class="p">()</span> <span class="o">:</span> <span class="o">*</span><span class="n">editor_ptr</span><span class="p">;</span>

    <span class="kt">char</span><span class="o">*</span> <span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">ImGui</span><span class="o">::</span><span class="n">MemAlloc</span><span class="p">(</span><span class="n">data_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">buf_end</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">data_size</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
    <span class="n">buf</span><span class="p">[</span><span class="n">data_size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">line_handler</span><span class="p">)(</span><span class="n">EditorContext</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">);</span>
    <span class="n">line_handler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">line_end</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">line</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">buf_end</span><span class="p">;</span> <span class="n">line</span> <span class="o">=</span> <span class="n">line_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">line</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">line</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">line</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">line_end</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">line_end</span> <span class="o">&lt;</span> <span class="n">buf_end</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">line_end</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">line_end</span> <span class="o">!=</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">line_end</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">line_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">line</span> <span class="o">==</span> <span class="sc">&#39;;&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">line</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">line_end</span><span class="p">[</span><span class="mi">-1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">line_end</span><span class="p">[</span><span class="mi">-1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;node&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">line_handler</span> <span class="o">=</span> <span class="n">node_line_handler</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;editor&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">line_handler</span> <span class="o">=</span> <span class="n">editor_line_handler</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">line_handler</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">line_handler</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">MemFree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SaveCurrentEditorStateToIniFile</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">file_name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SaveEditorStateToIniFile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">editor_context_get</span><span class="p">(),</span> <span class="n">file_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SaveEditorStateToIniFile</span><span class="p">(</span><span class="k">const</span> <span class="n">EditorContext</span><span class="o">*</span> <span class="k">const</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">file_name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">data_size</span> <span class="o">=</span> <span class="mi">0u</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="n">SaveEditorStateToIniString</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_size</span><span class="p">);</span>
    <span class="kt">FILE</span><span class="o">*</span> <span class="n">file</span> <span class="o">=</span> <span class="n">ImFileOpen</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">&quot;wt&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">fwrite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">LoadCurrentEditorStateFromIniFile</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">file_name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">LoadEditorStateFromIniFile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">editor_context_get</span><span class="p">(),</span> <span class="n">file_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">LoadEditorStateFromIniFile</span><span class="p">(</span><span class="n">EditorContext</span><span class="o">*</span> <span class="k">const</span> <span class="n">editor</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">file_name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">data_size</span> <span class="o">=</span> <span class="mi">0u</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">file_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">ImFileLoadToMemory</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data_size</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file_data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">LoadEditorStateFromIniString</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">file_data</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
    <span class="n">ImGui</span><span class="o">::</span><span class="n">MemFree</span><span class="p">(</span><span class="n">file_data</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">}</span> <span class="c1">// namespace nodes</span>
<span class="p">}</span> <span class="c1">// namespace imgui</span>
</pre></div>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation index</a><ul>
  </ul></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/api/program_listing_file__home_runner_work_Legion-Engine.rythe-legacy_Legion-Engine.rythe-legacy_legion_engine_rendering_imgui_impl_imnodes.cpp.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
  </body>
</html>